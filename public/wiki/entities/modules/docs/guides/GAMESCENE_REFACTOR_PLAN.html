<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GAMESCENE_REFACTOR_PLAN.md - Boiling Water Wiki</title>
  <link rel="stylesheet" href="/wiki/assets/styles.css" />
  <!-- Kekule CSS loaded lazily when molecule viewer is needed -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />
</head>
<body>
  <div class="wiki-layout">
    <div class="wiki-main">
      <header class="wiki-topbar">
        <details class="wiki-menu" aria-label="Menu">
          <summary>‚ò∞ Menu</summary>
          <nav class="wiki-menu-links">
            <div class="menu-section">
              <div class="menu-heading">Main</div>
              <a href="/wiki/index.html">üìö Main page</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Science</div>
              <a href="/wiki/entities/elements/index.html">‚öõÔ∏è Elements</a>
              <a href="/wiki/entities/compounds/index.html">üß™ Compounds</a>
              <a href="/wiki/entities/solutions/index.html">üíß Solutions</a>
              <a href="/wiki/entities/phases/index.html">‚ùÑÔ∏è Phases</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Game Structure</div>
              <a href="/wiki/entities/levels/index.html">üìä Levels</a>
              <a href="/wiki/entities/experiments/index.html">üî¨ Experiments</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Code Reference</div>
              <a href="/wiki/entities/formulas/index.html">üìê Formulas</a>
              <a href="/wiki/entities/processes/index.html">‚öôÔ∏è Processes</a>
              <a href="/wiki/entities/modules/index.html">üì¶ Modules</a>
              <a href="/wiki/entities/symbols/index.html">üî£ Symbols</a>
              <a href="/wiki/entities/public/index.html">üìÅ Public Files</a>
              <a href="/wiki/entities/assets/index.html">üñºÔ∏è Assets</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Repository</div>
              <a href="/wiki/entities/docs/index.html">üìñ Docs</a>
              <a href="/wiki/entities/scripts/index.html">üß∞ Scripts</a>
              <a href="/wiki/entities/styles/index.html">üé® Styles</a>
              <a href="/wiki/entities/root-files/index.html">üóÇÔ∏è Root Files</a>
              <a href="/wiki/entities/reports/changes-since-last-commit.html">üß≠ Changes</a>
            </div>
            <div class="wiki-menu-divider"></div>
            <a href="/">‚¨ÖÔ∏è Back to Game</a>
          </nav>
        </details>
        
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <a href="/wiki/../../../index.html">Main</a> <span class="breadcrumb-sep">‚Ä∫</span> <a href="/wiki/../index.html">Modules</a> <span class="breadcrumb-sep">‚Ä∫</span> <a href="/wiki/../docs/index.html">docs</a> <span class="breadcrumb-sep">‚Ä∫</span> <a href="/wiki/../docs/guides/index.html">guides</a> <span class="breadcrumb-sep">‚Ä∫</span> <span>GAMESCENE_REFACTOR_PLAN.md</span>
        </nav>
        <div class="wiki-topbar-title">GAMESCENE_REFACTOR_PLAN.md</div>
      </header>
      <main class="wiki-content">
        
        <article class="wiki-article">
          
      
    <aside class="infobox">
      <div class="infobox-title">GAMESCENE_REFACTOR_PLAN.md</div>
      
      <div class="infobox-row">
        <div class="infobox-label">Type</div>
        <div class="infobox-value">Module</div>
      </div>
    
      <div class="infobox-row">
        <div class="infobox-label">File type</div>
        <div class="infobox-value">md</div>
      </div>
    
    </aside>
  
      <section class="section">
        
  <div class="entity-header">
    <h1>GAMESCENE_REFACTOR_PLAN.md</h1>
    <p class="subtitle">Module</p>
  </div>

      </section>
      
      <section class="section" id="source-file">
        <h2>Source file</h2>
        <p><code>docs\guides\GAMESCENE_REFACTOR_PLAN.md</code></p>
        <details>
          <summary>View source code</summary>
          <pre class="line-numbers"><code class="language-markdown"># GameScene.jsx Refactor Plan - Extract ControlPanel

## Current State Analysis

**File:** `src/components/GameScene.jsx`  
**Size:** 1552 lines  
**Main responsibilities:** Physics, dragging, rendering, status display, controls, location/altitude UI

---

## Control Panel UI Logic Identification

### Lines ~1420-1750 (330+ lines) - Status Panel Rendering
This is the main control panel that floats in the game scene:

```jsx
&lt;div className=&quot;status-panel&quot;&gt;
  &lt;div className=&quot;status-content&quot;&gt;
    // 1. Display items (Ambient temp, Substance, Liquid mass, Boiling point, etc.)
    &lt;div className=&quot;status-item&quot;&gt;
    // 2. Timer controls (with start/stop/reset buttons)
    &lt;div className=&quot;timer-controls&quot;&gt;
    // 3. Expected boil time estimate
    &lt;div className=&quot;status-item&quot;&gt; Est. Time...
    // 4. Fluid selector dropdown
    &lt;div className=&quot;fluid-selector&quot;&gt;
    // 5. Speed controls (basic and advanced modes)
    &lt;button className=&quot;action-button speed-button&quot;&gt;
    &lt;div className=&quot;speed-controls-advanced&quot;&gt;
    // 6. Heating/cooling/boiling status text
    &lt;p className=&quot;status-text&quot;&gt;
    // 7. Empty pot hint
    &lt;p className=&quot;hint-text&quot;&gt;
    // 8. Altitude controls (input + location button)
    &lt;div className=&quot;altitude-control&quot;&gt;
  &lt;/div&gt;
&lt;/div&gt;
```

### Lines ~1750-1850+ (100+ lines) - Location Popup
Modal that appears for location/altitude selection:
```jsx
{showLocationPopup &amp;&amp; isLocationPopupAllowed &amp;&amp; (
  &lt;div className=&quot;location-panel&quot;&gt;
    // Location search input
    &lt;input type=&quot;text&quot; placeholder=&quot;Enter city...&quot;&gt;
    // Location buttons
    &lt;button onClick={handleSearchLocation}&gt;
    &lt;button onClick={handleFindMyLocation}&gt;
    &lt;button onClick={handleSetManualAltitude}&gt;
  &lt;/div&gt;
)}
```

---

## Required Props &amp; Callbacks

### Props (Data flowing in):
```javascript
// Game state
waterInPot, liquidMass, temperature, isBoiling
residueMass, fluidName, boilingPoint, boilingPointSeaLevel
canBoil, isPotOverFlame, expectedBoilTime, formatTemperature

// UI state
timeSpeed, isTimerRunning, timeElapsed
activeExperiment, activeFluid, availableFluids
showSelectors, isAdvancedModeAvailable
altitude, location, locationName, hasSetLocation
userZipCode, manualAltitude, showLocationPopup
isLocationPopupAllowed, locationError, isLoadingLocation

// Config constants
burnerHeat, wattageSteps, maxHeatIndex
GAME_CONFIG (ROOM_TEMPERATURE)

// Advanced
editableAltitude
```

### Callbacks (Methods flowing out):
```javascript
// Burner/Heat controls
handleBurnerKnob, handleHeatUp, handleHeatDown

// Timer controls
handleTimerToggle, handleTimerReset

// Speed controls
handleSpeedUp, handleSpeedDouble, handleSpeedHalve

// Fluid selection
handleFluidChange

// Location/Altitude
handleSearchLocation, handleSetManualAltitude, handleFindMyLocation, handleResetLocation
onLocationChange

// State setters
setTimeSpeed, setIsTimerRunning, setTimeElapsed
setActiveFluid, setEditableAltitude
setUserZipCode, setManualAltitude, setShowLocationPopup
setLocationError, setLocationName, setIsLoadingLocation, setHasSetLocation
```

---

## Extraction Strategy

### Component: `ControlPanel.jsx` (new)
**Location:** `src/components/ControlPanel.jsx`  
**Responsibility:** Render status display, timers, controls, dropdowns, altitude/location UI

**Props:** ~20 items (game state, UI state, config)  
**Callbacks:** ~10 methods (heat, timer, speed, location, etc.)

### Component: `LocationPopup.jsx` (optional - can stay in GameScene for now)
**Responsibility:** Modal for location/altitude selection  
**Decision:** Extract if ControlPanel becomes &gt;200 lines, otherwise keep in GameScene

---

## Refactoring Steps

### Phase 1: Create ControlPanel Component
1. Create `src/components/ControlPanel.jsx`
2. Move all status-panel JSX from GameScene to ControlPanel
3. Accept props and callbacks
4. Import necessary utilities (formatTime, etc.)

### Phase 2: Update GameScene
1. Replace inline JSX with `&lt;ControlPanel {...props} /&gt;`
2. Keep all state and logic in GameScene (no state lifting needed yet)
3. Pass props via spread or explicit list
4. Keep location popup in GameScene for now (coupled with location logic)

### Phase 3: Testing &amp; Cleanup
1. Verify game still works: dragging, heating, boiling, controls
2. Test all modes: basic mode, advanced mode, all experiments
3. Verify location popup still works
4. Check console for errors

### Phase 4 (Optional): Extract LocationPopup
If ControlPanel is still &gt;250 lines after Phase 2:
1. Create `src/components/LocationPopup.jsx`
2. Move modal JSX from GameScene to LocationPopup
3. Pass location state and callbacks

---

## Files Affected

### Modified:
- `src/components/GameScene.jsx` - Remove ~330 lines of JSX, add 1 component call
- `src/components/ControlPanel.jsx` - NEW, ~400 lines
- `src/styles/GameScene.css` - No changes expected (classes stay the same)

### Unchanged:
- All logic files (physics.js, locationUtils.js, etc.)
- All state management (stays in GameScene)
- Imports and dependencies

---

## Success Criteria

‚úÖ GameScene.jsx reduces to ~1150-1200 lines  
‚úÖ ControlPanel.jsx is ~350-400 lines  
‚úÖ Game functionality unchanged (dragging, heating, boiling all work)  
‚úÖ All controls work (burner, timer, speed, fluid, location)  
‚úÖ No console errors or warnings  
‚úÖ Responsive to screen size changes  

---

## Rollback Plan

If issues arise:
- Revert to commit `f488c77` (pre-work checkpoint)
- No complexity added; pure extraction with no logic changes
</code></pre>
        </details>
      </section>
    
        </article>
      </main>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
  <script>
    // Lazy-load Kekule only when molecule viewer is expanded (saves bandwidth on low-end devices)
    (() => {
      let smilesDrawerLoaded = false
      let smilesDrawerLoading = false
      
      // Convert explicit SMILES like [CH3][CH](OH)[CH3] to standard like CC(O)C
      const explicitToStandard = (smiles) => {
        return smiles
          // Common organic groups - order matters (longer patterns first)
          .replace(/\[CH3\]/g, 'C')
          .replace(/\[CH2\]/g, 'C')
          .replace(/\[CH\]/g, 'C')
          .replace(/\[OH\]/g, 'O')
          .replace(/\[NH2\]/g, 'N')
          .replace(/\[NH\]/g, 'N')
          .replace(/\[SH\]/g, 'S')
          // Single atoms in brackets (keep aromatic lowercase)
          .replace(/\[C\]/g, 'C')
          .replace(/\[N\]/g, 'N')
          .replace(/\[O\]/g, 'O')
          .replace(/\[S\]/g, 'S')
          .replace(/\[P\]/g, 'P')
          .replace(/\[F\]/g, 'F')
          .replace(/\[Cl\]/g, 'Cl')
          .replace(/\[Br\]/g, 'Br')
          .replace(/\[I\]/g, 'I')
          // Bare atoms in branches - H is implicit in standard SMILES
          .replace(/\(OH\)/g, '(O)')
          .replace(/\(NH2\)/g, '(N)')
          .replace(/\(NH\)/g, '(N)')
          .replace(/\(SH\)/g, '(S)')
      }
      
      const loadSmilesDrawer = async () => {
        if (smilesDrawerLoaded) return
        if (smilesDrawerLoading) {
          return new Promise(resolve => {
            const check = setInterval(() => {
              if (smilesDrawerLoaded) { clearInterval(check); resolve() }
            }, 50)
          })
        }
        smilesDrawerLoading = true
        
        // Load SmilesDrawer from CDN (much simpler than Kekule)
        await new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = 'https://unpkg.com/smiles-drawer@2.1.7/dist/smiles-drawer.min.js'
          script.onload = resolve
          script.onerror = reject
          document.body.appendChild(script)
        })
        
        smilesDrawerLoaded = true
        smilesDrawerLoading = false
      }
      
      const initMolecule = async (node) => {
        if (node.dataset.initialized) return
        node.dataset.initialized = 'true'
        
        const rawSmiles = node.getAttribute('data-smiles')
        if (!rawSmiles) return
        
        // Convert explicit format to standard if needed
        const smiles = explicitToStandard(rawSmiles)
        
        try {
          await loadSmilesDrawer()
          
          const drawer = new SmilesDrawer.SvgDrawer({ 
            width: 300, 
            height: 200,
            explicitHydrogens: true,
            terminalCarbons: true,
            compactDrawing: false
          })
          
          console.log('Parsing SMILES:', rawSmiles, '->', smiles)
          SmilesDrawer.parse(smiles, (tree) => {
            console.log('Parse success, tree:', tree)
            const svgElement = drawer.draw(tree, null, 'light')
            console.log('SVG element:', svgElement)
            node.innerHTML = ''
            node.appendChild(svgElement)
          }, (err) => {
            console.error('SMILES parse error for "' + smiles + '":', err)
            node.innerHTML = '<code>' + rawSmiles + '</code>'
          })
        } catch (err) {
          console.error('SmilesDrawer load error:', err)
          node.innerHTML = '<code>' + smiles + '</code>'
        }
      }
      
      // Use IntersectionObserver for lazy loading when scrolled into view
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initMolecule(entry.target)
            observer.unobserve(entry.target)
          }
        })
      }, { rootMargin: '100px' })
      
      // Also handle <details> expansion for molecules inside collapsed sections
      document.addEventListener('toggle', (e) => {
        if (e.target.tagName === 'DETAILS' && e.target.open) {
          const molecules = e.target.querySelectorAll('[data-smiles]:not([data-initialized])')
          molecules.forEach(node => initMolecule(node))
        }
      }, true)
      
      // Observe all molecule nodes
      const init = () => {
        const nodes = document.querySelectorAll('[data-smiles]')
        nodes.forEach(node => observer.observe(node))
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init)
      } else {
        init()
      }
    })()
  </script>
</body>
</html>