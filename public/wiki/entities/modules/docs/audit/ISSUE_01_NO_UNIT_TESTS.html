<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISSUE_01_NO_UNIT_TESTS.md - Boiling Water Wiki</title>
  <link rel="stylesheet" href="/wiki/assets/styles.css" />
  <!-- Kekule CSS loaded lazily when molecule viewer is needed -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />
</head>
<body>
  <div class="wiki-layout">
    <div class="wiki-main">
      <header class="wiki-topbar">
        <details class="wiki-menu" aria-label="Menu">
          <summary>â˜° Menu</summary>
          <nav class="wiki-menu-links">
            <div class="menu-section">
              <div class="menu-heading">Main</div>
              <a href="/wiki/index.html">ğŸ“š Main page</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Science</div>
              <a href="/wiki/entities/elements/index.html">âš›ï¸ Elements</a>
              <a href="/wiki/entities/compounds/index.html">ğŸ§ª Compounds</a>
              <a href="/wiki/entities/solutions/index.html">ğŸ’§ Solutions</a>
              <a href="/wiki/entities/phases/index.html">â„ï¸ Phases</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Game Structure</div>
              <a href="/wiki/entities/levels/index.html">ğŸ“Š Levels</a>
              <a href="/wiki/entities/experiments/index.html">ğŸ”¬ Experiments</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Code Reference</div>
              <a href="/wiki/entities/formulas/index.html">ğŸ“ Formulas</a>
              <a href="/wiki/entities/processes/index.html">âš™ï¸ Processes</a>
              <a href="/wiki/entities/modules/index.html">ğŸ“¦ Modules</a>
              <a href="/wiki/entities/symbols/index.html">ğŸ”£ Symbols</a>
              <a href="/wiki/entities/public/index.html">ğŸ“ Public Files</a>
              <a href="/wiki/entities/assets/index.html">ğŸ–¼ï¸ Assets</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Repository</div>
              <a href="/wiki/entities/docs/index.html">ğŸ“– Docs</a>
              <a href="/wiki/entities/scripts/index.html">ğŸ§° Scripts</a>
              <a href="/wiki/entities/styles/index.html">ğŸ¨ Styles</a>
              <a href="/wiki/entities/root-files/index.html">ğŸ—‚ï¸ Root Files</a>
              <a href="/wiki/entities/reports/changes-since-last-commit.html">ğŸ§­ Changes</a>
            </div>
            <div class="wiki-menu-divider"></div>
            <a href="/">â¬…ï¸ Back to Game</a>
          </nav>
        </details>
        
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <a href="/wiki/../../../index.html">Main</a> <span class="breadcrumb-sep">â€º</span> <a href="/wiki/../index.html">Modules</a> <span class="breadcrumb-sep">â€º</span> <a href="/wiki/../docs/index.html">docs</a> <span class="breadcrumb-sep">â€º</span> <a href="/wiki/../docs/audit/index.html">audit</a> <span class="breadcrumb-sep">â€º</span> <span>ISSUE_01_NO_UNIT_TESTS.md</span>
        </nav>
        <div class="wiki-topbar-title">ISSUE_01_NO_UNIT_TESTS.md</div>
      </header>
      <main class="wiki-content">
        
        <article class="wiki-article">
          
      
    <aside class="infobox">
      <div class="infobox-title">ISSUE_01_NO_UNIT_TESTS.md</div>
      
      <div class="infobox-row">
        <div class="infobox-label">Type</div>
        <div class="infobox-value">Module</div>
      </div>
    
      <div class="infobox-row">
        <div class="infobox-label">File type</div>
        <div class="infobox-value">md</div>
      </div>
    
    </aside>
  
      <section class="section">
        
  <div class="entity-header">
    <h1>ISSUE_01_NO_UNIT_TESTS.md</h1>
    <p class="subtitle">Module</p>
  </div>

      </section>
      
      <section class="section" id="source-file">
        <h2>Source file</h2>
        <p><code>docs\audit\ISSUE_01_NO_UNIT_TESTS.md</code></p>
        <details>
          <summary>View source code</summary>
          <pre class="line-numbers"><code class="language-markdown"># Issue #1: No Unit Tests or Test Framework

**Severity:** ğŸ”´ Critical  
**Status:** âŒ Missing  
**Priority:** P0 - Must have before production  
**Effort:** 2-3 weeks (to write tests for critical paths)

---

## What It Means

Your project has **zero automated tests**. When you change code, there&#39;s no system checking if you broke anything.

---

## Why It&#39;s Critical

### Scenario: You Modify the Physics Engine

```javascript
// src/utils/physics.js - You make this change:

// OLD (working)
export function simulateTimeStep(state, heat, deltaTime, fluidProps) {
  const newTemp = state.temperature + (heat / (state.waterMass * fluidProps.specificHeat)) * deltaTime
  return { ...state, temperature: newTemp }
}

// NEW (you refactor to be &quot;cleaner&quot;)
export function simulateTimeStep(state, heat, deltaTime, fluidProps) {
  const newTemp = state.temperature + (heat * deltaTime) / (state.waterMass * fluidProps.specificHeat)
  return { ...state, temperature: newTemp }
}
```

This **looks the same** mathematically, but introduces a bug (order of operations changed).

### Without Tests âŒ
- You don&#39;t notice until a user reports &quot;water boils at wrong temperature&quot;
- You can&#39;t pinpoint where the bug came from
- You have to manually test every scenario yourself

### With Tests âœ…
- Test runs automatically: `assert boilingPointAt20kPressure === 68.3Â°C` fails immediately
- You know exactly what broke
- You can confidently refactor

---

## Test Coverage Explained

**Industry Standard: 70-80% Coverage**

This means 70-80% of your **code lines** are executed during tests.

### Example: calculateBoilingPoint Function

```javascript
export function calculateBoilingPoint(altitude, fluidProps) {
  if (!fluidProps) return null                    // Line 1
  
  const pressure = getPressureAtAltitude(altitude) // Line 2
  if (pressure &lt; 0) return null                   // Line 3
  
  return solveAntoineEquation(pressure, fluidProps) // Line 4
}
```

An **80% coverage test suite** would test 3-4 of these 4 lines:

| Test Case | What It Tests | Status |
|-----------|---------------|--------|
| Normal altitude (0m) | Lines 1, 2, 4 | âœ… Tested |
| High altitude (20km) | Lines 1, 2, 4 | âœ… Tested |
| Negative pressure edge case | Line 3 | âœ… Tested |
| Some weird edge case | ? | âŒ Untested (20% gap) |

---

## The Test Pyramid

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   E2E Tests (10%)       â”‚
        â”‚  User clicks â†’ water    â”‚
        â”‚  boils in game window   â”‚
        â”‚  (slow, expensive)      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Integration Tests (30%) â”‚
        â”‚ Physics + Room env +    â”‚
        â”‚ UI state together       â”‚
        â”‚ (medium speed/cost)     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  Unit Tests (60%)       â”‚
        â”‚ calculateBoilingPoint() â”‚
        â”‚ returns 84.5 at 5000m   â”‚
        â”‚ (fast, cheap, many)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Your project has:** Zero at all levels âŒ

---

## How This Affects Your Project Today

### Physics Calculations Are Especially Vulnerable

```javascript
// src/utils/physics/formulas/latentHeat.js
export function calculateVaporizationEnergy(massKg, heatOfVapKJ) {
  const heatOfVapJ = heatOfVapKJ * 1000
  return massKg * heatOfVapJ
}
```

**Without tests, these questions are unanswered:**
- Is this calculation correct? (1 kg water at 2257 kJ/kg should = 2,257,000 J âœ“)
- What if someone passes 0? Does it return 0 or crash?
- What if they pass negative numbers? (physically impossible but program should handle it)
- Is the conversion factor correct? (1000 is right, but documented why?)
- Does it work with all fluid types?

### With Tests

```javascript
// src/utils/physics/formulas/__tests__/latentHeat.test.js

import { describe, it, expect } from &#39;vitest&#39;
import { calculateVaporizationEnergy } from &#39;../latentHeat&#39;

describe(&#39;calculateVaporizationEnergy&#39;, () =&gt; {
  it(&#39;should calculate energy for 1kg water&#39;, () =&gt; {
    expect(calculateVaporizationEnergy(1, 2257)).toBe(2257000)
  })
  
  it(&#39;should handle zero mass&#39;, () =&gt; {
    expect(calculateVaporizationEnergy(0, 2257)).toBe(0)
  })
  
  it(&#39;should scale linearly with mass&#39;, () =&gt; {
    expect(calculateVaporizationEnergy(2, 2257)).toBe(4514000)
    expect(calculateVaporizationEnergy(0.5, 2257)).toBe(1128500)
  })
  
  it(&#39;should reject negative mass&#39;, () =&gt; {
    expect(() =&gt; calculateVaporizationEnergy(-1, 2257)).toThrow(&#39;Mass cannot be negative&#39;)
  })
  
  it(&#39;should work with ethanol (lower Lv)&#39;, () =&gt; {
    expect(calculateVaporizationEnergy(1, 838)).toBe(838000)
  })
})
```

All 5 tests run in **&lt; 10ms**. If any break, you know immediately.

---

## Real Cost Comparison

### Without Tests

| Change | Time to Find Bug | User Impact | Severity |
|--------|------------------|-------------|----------|
| Fix altitude formula | 2-3 hours manual testing | Boiling points wrong at high altitude | ğŸ”´ High |
| Refactor cooling calculation | 4-5 hours of testing | Water cools too fast/slow | ğŸ”´ High |
| Add room pressure feedback | 6-8 hours of testing | Complex physics breaks silently | ğŸ”´ Critical |
| Update Antoine coefficients | 1-2 hours manual testing | Substances boil at wrong temps | ğŸ”´ High |

### With Tests

| Change | Time to Find Bug | User Impact | Severity |
|--------|------------------|-------------|----------|
| Fix altitude formula | 30 seconds (test fails) | Caught before deploy | âœ… None |
| Refactor cooling calculation | 30 seconds | Caught before deploy | âœ… None |
| Add room pressure feedback | 30 seconds | Caught before deploy | âœ… None |
| Update Antoine coefficients | 30 seconds | Caught before deploy | âœ… None |

---

## Critical Areas That Need Tests

### 1. Physics Engine (`src/utils/physics/`)

```javascript
// Priority: HIGHEST
// Why: All game mechanics depend on this

- calculateBoilingPoint(altitude, fluidProps)  // Affects every experiment
- simulateTimeStep(state, heat, deltaTime)     // Runs every 100ms
- solveAntoineEquation(pressure, coefficients) // Core calculation
- calculateVaporizationEnergy()                // Phase change logic
```

### 2. Room Environment (`src/utils/roomEnvironment.js`)

```javascript
// Priority: HIGH
// Why: Feedback loop - pressure affects boiling point affects pressure

- applyAcControl()                             // Temperature regulation
- applyScrubber()                              // Air composition
- addVapor()                                   // Boiling â†’ room pressure
```

### 3. Substance Loader (`src/utils/substanceLoader.js`)

```javascript
// Priority: MEDIUM
// Why: Wrong data = wrong physics

- loadSubstance()                              // Verify JSON loads correctly
- parseSubstanceProperties()                   // Verify parsing logic
- getAvailableSubstances()                     // Verify catalog integrity
```

### 4. UI State Management (`src/App.jsx`, `src/components/GameScene.jsx`)

```javascript
// Priority: MEDIUM
// Why: Prevent regression on complex state flows

- Level/experiment transitions
- Pot dragging and collision detection
- Equipment switching logic
```

---

## Implementation Steps

### Step 1: Set Up Testing Infrastructure (1 day)

```bash
# Install dependencies
npm install --save-dev vitest @vitest/ui @testing-library/react @testing-library/jest-dom jsdom

# Update package.json
npm set-script test &quot;vitest&quot;
npm set-script test:ui &quot;vitest --ui&quot;
npm set-script test:coverage &quot;vitest --coverage&quot;
```

### Step 2: Create First Test File (1 day)

```javascript
// src/utils/physics/formulas/__tests__/latentHeat.test.js

import { describe, it, expect } from &#39;vitest&#39;
import { 
  calculateVaporizationEnergy,
  calculateVaporizedMass,
  calculateFusionEnergy
} from &#39;../latentHeat&#39;

describe(&#39;Latent Heat Calculations&#39;, () =&gt; {
  describe(&#39;calculateVaporizationEnergy&#39;, () =&gt; {
    it(&#39;should calculate energy for 1kg water&#39;, () =&gt; {
      const energy = calculateVaporizationEnergy(1, 2257)
      expect(energy).toBe(2257000)
    })

    it(&#39;should handle zero mass&#39;, () =&gt; {
      const energy = calculateVaporizationEnergy(0, 2257)
      expect(energy).toBe(0)
    })

    it(&#39;should scale with different fluids&#39;, () =&gt; {
      expect(calculateVaporizationEnergy(1, 2257)).toBe(2257000)  // Water
      expect(calculateVaporizationEnergy(1, 838)).toBe(838000)    // Ethanol
      expect(calculateVaporizationEnergy(1, 518)).toBe(518000)    // Acetone
    })
  })

  describe(&#39;calculateVaporizedMass&#39;, () =&gt; {
    it(&#39;should calculate mass from energy&#39;, () =&gt; {
      const mass = calculateVaporizedMass(2257000, 2257)
      expect(mass).toBeCloseTo(1, 5)
    })

    it(&#39;should handle zero energy&#39;, () =&gt; {
      expect(calculateVaporizedMass(0, 2257)).toBe(0)
    })
  })

  describe(&#39;calculateFusionEnergy&#39;, () =&gt; {
    it(&#39;should calculate energy for ice melting&#39;, () =&gt; {
      const energy = calculateFusionEnergy(1, 334)
      expect(energy).toBe(334000)
    })
  })
})
```

### Step 3: Run Tests

```bash
npm run test
```

**Output:**
```
âœ“ src/utils/physics/formulas/__tests__/latentHeat.test.js (5 tests)

Test Files  1 passed (1)
     Tests  5 passed (5)
  Start at  14:32:05
  Duration  245ms
```

### Step 4: Expand Test Coverage (1-2 weeks)

Target critical paths:
- Physics formulas (Antoine, ISA, cooling)
- Boiling point calculations
- Room environment feedback loops
- Substance loading/parsing
- State transitions

---

## Why This Is Crucial for Boiling Water

Your project is an **educational physics simulator** that teaches real science. This makes testing even more critical:

1. **Physics calculations must be bulletproof**
   - One formula bug spreads misinformation to students
   - Users rely on accuracy for learning
   - Wrong boiling points undermine educational value

2. **Complex feedback loops require regression testing**
   - Room pressure â†’ boiling point â†’ vapor release â†’ room pressure
   - Without tests, you can&#39;t safely refactor interconnected systems

3. **Altitude system is globally used**
   - Every experiment depends on `calculateBoilingPoint()`
   - One bug affects all 118 substances globally

4. **Multiple experimental flows**
   - Boiling water (tutorial)
   - Altitude effects
   - Different fluids
   - Dangerous liquids (L1E4+)
   - Each needs to work independently

---

## Success Metrics

Once testing is implemented:

| Metric | Target | Current |
|--------|--------|---------|
| Test Coverage | 70%+ | 0% |
| Physics Formulas Tested | 100% | 0% |
| Critical Paths Tested | 100% | 0% |
| Test Execution Time | &lt; 1 second | N/A |
| CI/CD Test Stage | âœ… Pass required | âŒ No tests run |

---

## Next Steps

1. **Read:** [Vitest docs](https://vitest.dev/) (30 minutes)
2. **Install:** Testing dependencies (5 minutes)
3. **Write:** First 5 tests for physics formulas (2 hours)
4. **Expand:** 20-30 more tests for core paths (1 week)
5. **Integrate:** CI/CD pipeline runs tests on every push (1 day)

---

## Related Issues

- [Issue #2: No TypeScript](../INDUSTRY_STANDARDS_AUDIT.md#2-no-typescript-type-safety) (would make tests easier)
- [Issue #5: No CI/CD Testing](../INDUSTRY_STANDARDS_AUDIT.md#5-no-cicd-testing-pipeline) (needs tests to run)
- [Remediation Phase 1](../INDUSTRY_STANDARDS_AUDIT.md#phase-1-foundation-weeks-1-2)

---

**Status:** Ready for implementation  
**Blocking:** Production deployment  
**Time to implement:** 2-3 weeks
</code></pre>
        </details>
      </section>
    
        </article>
      </main>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
  <script>
    // Lazy-load Kekule only when molecule viewer is expanded (saves bandwidth on low-end devices)
    (() => {
      let smilesDrawerLoaded = false
      let smilesDrawerLoading = false
      
      // Convert explicit SMILES like [CH3][CH](OH)[CH3] to standard like CC(O)C
      const explicitToStandard = (smiles) => {
        return smiles
          // Common organic groups - order matters (longer patterns first)
          .replace(/\[CH3\]/g, 'C')
          .replace(/\[CH2\]/g, 'C')
          .replace(/\[CH\]/g, 'C')
          .replace(/\[OH\]/g, 'O')
          .replace(/\[NH2\]/g, 'N')
          .replace(/\[NH\]/g, 'N')
          .replace(/\[SH\]/g, 'S')
          // Single atoms in brackets (keep aromatic lowercase)
          .replace(/\[C\]/g, 'C')
          .replace(/\[N\]/g, 'N')
          .replace(/\[O\]/g, 'O')
          .replace(/\[S\]/g, 'S')
          .replace(/\[P\]/g, 'P')
          .replace(/\[F\]/g, 'F')
          .replace(/\[Cl\]/g, 'Cl')
          .replace(/\[Br\]/g, 'Br')
          .replace(/\[I\]/g, 'I')
          // Bare atoms in branches - H is implicit in standard SMILES
          .replace(/\(OH\)/g, '(O)')
          .replace(/\(NH2\)/g, '(N)')
          .replace(/\(NH\)/g, '(N)')
          .replace(/\(SH\)/g, '(S)')
      }
      
      const loadSmilesDrawer = async () => {
        if (smilesDrawerLoaded) return
        if (smilesDrawerLoading) {
          return new Promise(resolve => {
            const check = setInterval(() => {
              if (smilesDrawerLoaded) { clearInterval(check); resolve() }
            }, 50)
          })
        }
        smilesDrawerLoading = true
        
        // Load SmilesDrawer from CDN (much simpler than Kekule)
        await new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = 'https://unpkg.com/smiles-drawer@2.1.7/dist/smiles-drawer.min.js'
          script.onload = resolve
          script.onerror = reject
          document.body.appendChild(script)
        })
        
        smilesDrawerLoaded = true
        smilesDrawerLoading = false
      }
      
      const initMolecule = async (node) => {
        if (node.dataset.initialized) return
        node.dataset.initialized = 'true'
        
        const rawSmiles = node.getAttribute('data-smiles')
        if (!rawSmiles) return
        
        // Convert explicit format to standard if needed
        const smiles = explicitToStandard(rawSmiles)
        
        try {
          await loadSmilesDrawer()
          
          const drawer = new SmilesDrawer.SvgDrawer({ 
            width: 300, 
            height: 200,
            explicitHydrogens: true,
            terminalCarbons: true,
            compactDrawing: false
          })
          
          console.log('Parsing SMILES:', rawSmiles, '->', smiles)
          SmilesDrawer.parse(smiles, (tree) => {
            console.log('Parse success, tree:', tree)
            const svgElement = drawer.draw(tree, null, 'light')
            console.log('SVG element:', svgElement)
            node.innerHTML = ''
            node.appendChild(svgElement)
          }, (err) => {
            console.error('SMILES parse error for "' + smiles + '":', err)
            node.innerHTML = '<code>' + rawSmiles + '</code>'
          })
        } catch (err) {
          console.error('SmilesDrawer load error:', err)
          node.innerHTML = '<code>' + smiles + '</code>'
        }
      }
      
      // Use IntersectionObserver for lazy loading when scrolled into view
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initMolecule(entry.target)
            observer.unobserve(entry.target)
          }
        })
      }, { rootMargin: '100px' })
      
      // Also handle <details> expansion for molecules inside collapsed sections
      document.addEventListener('toggle', (e) => {
        if (e.target.tagName === 'DETAILS' && e.target.open) {
          const molecules = e.target.querySelectorAll('[data-smiles]:not([data-initialized])')
          molecules.forEach(node => initMolecule(node))
        }
      }, true)
      
      // Observe all molecule nodes
      const init = () => {
        const nodes = document.querySelectorAll('[data-smiles]')
        nodes.forEach(node => observer.observe(node))
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init)
      } else {
        init()
      }
    })()
  </script>
</body>
</html>