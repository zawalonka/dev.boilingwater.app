<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameScene.jsx - Boiling Water Wiki</title>
  <link rel="stylesheet" href="/wiki/assets/styles.css" />
  <!-- Kekule CSS loaded lazily when molecule viewer is needed -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />
</head>
<body>
  <div class="wiki-layout">
    <div class="wiki-main">
      <header class="wiki-topbar">
        <details class="wiki-menu" aria-label="Menu">
          <summary>‚ò∞ Menu</summary>
          <nav class="wiki-menu-links">
            <div class="menu-section">
              <div class="menu-heading">Main</div>
              <a href="/wiki/index.html">üìö Main page</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Science</div>
              <a href="/wiki/entities/elements/index.html">‚öõÔ∏è Elements</a>
              <a href="/wiki/entities/compounds/index.html">üß™ Compounds</a>
              <a href="/wiki/entities/solutions/index.html">üíß Solutions</a>
              <a href="/wiki/entities/phases/index.html">‚ùÑÔ∏è Phases</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Game Structure</div>
              <a href="/wiki/entities/levels/index.html">üìä Levels</a>
              <a href="/wiki/entities/experiments/index.html">üî¨ Experiments</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Code Reference</div>
              <a href="/wiki/entities/formulas/index.html">üìê Formulas</a>
              <a href="/wiki/entities/processes/index.html">‚öôÔ∏è Processes</a>
              <a href="/wiki/entities/modules/index.html">üì¶ Modules</a>
              <a href="/wiki/entities/symbols/index.html">üî£ Symbols</a>
              <a href="/wiki/entities/public/index.html">üìÅ Public Files</a>
              <a href="/wiki/entities/assets/index.html">üñºÔ∏è Assets</a>
            </div>
            <div class="menu-section">
              <div class="menu-heading">Repository</div>
              <a href="/wiki/entities/docs/index.html">üìñ Docs</a>
              <a href="/wiki/entities/scripts/index.html">üß∞ Scripts</a>
              <a href="/wiki/entities/styles/index.html">üé® Styles</a>
              <a href="/wiki/entities/root-files/index.html">üóÇÔ∏è Root Files</a>
            </div>
            <div class="wiki-menu-divider"></div>
            <a href="/">‚¨ÖÔ∏è Back to Game</a>
          </nav>
        </details>
        
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <a href="/wiki/../../../index.html">Main</a> <span class="breadcrumb-sep">‚Ä∫</span> <a href="/wiki/../index.html">Modules</a> <span class="breadcrumb-sep">‚Ä∫</span> <a href="/wiki/../src/index.html">src</a> <span class="breadcrumb-sep">‚Ä∫</span> <a href="/wiki/../src/components/index.html">components</a> <span class="breadcrumb-sep">‚Ä∫</span> <span>GameScene.jsx</span>
        </nav>
        <div class="wiki-topbar-title">GameScene.jsx</div>
      </header>
      <main class="wiki-content">
        
        <article class="wiki-article">
          
      
    <aside class="infobox">
      <div class="infobox-title">GameScene.jsx</div>
      
      <div class="infobox-row">
        <div class="infobox-label">Type</div>
        <div class="infobox-value">React Component</div>
      </div>
    
      <div class="infobox-row">
        <div class="infobox-label">File type</div>
        <div class="infobox-value">jsx</div>
      </div>
    
      <div class="infobox-row">
        <div class="infobox-label">Imports</div>
        <div class="infobox-value"><span class="external-import">react</span>, <a href="/wiki/entities/modules/src/utils/physics/index.html">index.js</a>, <a href="/wiki/entities/modules/src/utils/substanceLoader.html">substanceLoader.js</a>, <a href="/wiki/entities/modules/src/constants/physics.html">physics.js</a>, <a href="/wiki/entities/modules/src/constants/workshops.html">workshops.js</a>, <a href="/wiki/entities/modules/src/components/ControlPanel.html">ControlPanel.jsx</a>, <a href="/wiki/entities/modules/src/components/RoomControls.html">RoomControls.jsx</a>, <a href="/wiki/entities/modules/src/hooks/useRoomEnvironment.html">useRoomEnvironment.js</a>, <a href="/wiki/entities/modules/src/utils/roomEnvironment.html">roomEnvironment.js</a></div>
      </div>
    
      <div class="infobox-row">
        <div class="infobox-label">Imported by</div>
        <div class="infobox-value"><ul><li><a href="/wiki/entities/modules/src/App.html">App.jsx</a></li></ul></div>
      </div>
    
    </aside>
  
      <section class="section">
        
  <div class="entity-header">
    <h1>GameScene.jsx</h1>
    <p class="subtitle">React Component</p>
  </div>

      </section>
      
    <section class="section">
      <h2>Educational notes</h2>
      <p>GameScene Component</p>
<p>This is the main interactive game environment for the Boiling Water educational app.</p>
<p>It displays a workshop-defined game window (default 1280x800) with a draggable pot, burner with flame,</p>
<p>sink for filling water, and physics simulation for heating/boiling water at different altitudes.</p>
<p>The component handles:</p>
<p>- Rendering the fixed-size game window and all visual elements</p>
<p>- Pot dragging via Pointer Events (works on mouse, touch, and pen)</p>
<p>- Physics simulation loop (runs every 100ms when heat is on)</p>
<p>- Water filling when pot touches sink</p>
<p>- Temperature display and boiling detection</p>
<p>- Educational messages about boiling points at different altitudes</p>
<p>- Stage 1 overlay with post-boil explainer and progression button</p>
    </section>
  
      <section class="section" id="source-file">
        <h2>Source file</h2>
        <p><code>src\components\GameScene.jsx</code></p>
        <details>
          <summary>View source code</summary>
          <pre class="line-numbers"><code class="language-jsx">Ôªø/**
 * GameScene Component
 * 
 * This is the main interactive game environment for the Boiling Water educational app.
 * It displays a workshop-defined game window (default 1280x800) with a draggable pot, burner with flame,
 * sink for filling water, and physics simulation for heating/boiling water at different altitudes.
 * 
 * The component handles:
 * - Rendering the fixed-size game window and all visual elements
 * - Pot dragging via Pointer Events (works on mouse, touch, and pen)
 * - Physics simulation loop (runs every 100ms when heat is on)
 * - Water filling when pot touches sink
 * - Temperature display and boiling detection
 * - Educational messages about boiling points at different altitudes
 * - Stage 1 overlay with post-boil explainer and progression button
 */

import { useState, useRef, useEffect, useMemo } from &#39;react&#39;
import { 
  calculateBoilingPoint,           // Calculates fluid&#39;s boiling point based on altitude
  calculateBoilingPointAtPressure, // Calculates fluid&#39;s boiling point based on pressure (for room feedback)
  simulateTimeStep,                // Runs one time step of physics (heating/cooling/boiling)
  formatTemperature,               // Formats temperature numbers for display (e.g., 98.5¬∞C)
  // Evaporation physics (pre-boiling)
  solveAntoineForPressure,         // Get vapor pressure at current temperature
  simulateEvaporationWithMassTransfer, // Mass transfer model (physically accurate evaporation)
  estimatePotSurfaceArea           // Estimate liquid surface area
} from &#39;../utils/physics&#39;
import { loadSubstance, loadSubstanceInfo, parseSubstanceProperties, DEFAULT_SUBSTANCE, getAvailableSubstances } from &#39;../utils/substanceLoader&#39;
import { GAME_CONFIG } from &#39;../constants/physics&#39;
import { LEVELS, EXPERIMENTS } from &#39;../constants/workshops&#39;
import ControlPanel from &#39;./ControlPanel&#39;
import RoomControls from &#39;./RoomControls&#39;
import { useRoomEnvironment } from &#39;../hooks/useRoomEnvironment&#39;
import { getAtmosphereKey } from &#39;../utils/roomEnvironment&#39;
import &#39;../styles/GameScene.css&#39;

// Default layout values (used if workshop layout not provided)
const DEFAULT_LAYOUT = {
  scene: { width: 1280, height: 800 },
  pot: {
    start: { xPercent: 75, yPercent: 45 },
    sizePercent: 36,
    dragBounds: { minX: 8, maxX: 92, minY: 8, maxY: 92 }
  },
  flame: {
    xPercent: 62.6,
    yPercent: 53.4,
    activationRadius: 6.25,
    sizePercentByHeat: [35, 37, 40, 45],
    minSizePxByHeat: [180, 200, 220, 240]
  },
  burnerKnob: {
    xPercent: 66.5,
    yPercent: 67.8,
    sizePercent: 5
  },
  waterStream: {
    xRange: [26, 30],
    yRange: [44, 72],
    start: { xPercent: 28.8, yPercent: 44.0 },
    end: { xPercent: 27.8, yPercent: 70.7 },
    widthPercent: 2
  }
}

function GameScene({ stage, location, onStageChange, workshopLayout, workshopImages, workshopEffects, burnerConfig, roomConfig, acUnitConfig, airHandlerConfig, activeLevel, activeExperiment, showSelectors, onWaterBoiled, onSkipTutorial, onLevelChange, onExperimentChange, hasBoiledBefore = false, onLocationChange, onEquipmentChange }) {
  const layout = workshopLayout || DEFAULT_LAYOUT
  const backgroundImage = workshopImages?.background || null
  const potEmptyImage = workshopImages?.pot_empty || null
  const potFullImage = workshopImages?.pot_full || null
  const flameImage = workshopImages?.flame || null
  const hasRequiredImages = Boolean(backgroundImage &amp;&amp; potEmptyImage &amp;&amp; potFullImage &amp;&amp; flameImage)
  // Workshop-driven optional visual effects (steam, flame glow)
  // Default: effects DISABLED unless workshop provides effects.json
  // This ensures simple workshops have no VFX overhead; only showcase workshops (like alpha) enable them
  const defaultEffects = {
    steam: {
      enabled: false,
      symbol: &#39;üí®&#39;,
      color: &#39;rgba(255, 255, 255, 0.95)&#39;,
      glow: &#39;rgba(255, 255, 255, 0.45)&#39;,
      sizeRem: 1.5,
      risePx: -40,
      durationMs: 1500,
      offset: { xPercent: 0, yPx: -30 }
    },
    flameGlow: {
      enabled: false,
      color: null, // falls back to --workshop-flame-glow
      blurPx: 16,
      flickerMs: null,
      intensityByHeat: [0, 1, 1.08, 1.16]
    },
    waterStream: {
      enabled: false
    }
  }

  const effects = {
    steam: { ...defaultEffects.steam, ...(workshopEffects?.steam || {}) },
    flameGlow: { ...defaultEffects.flameGlow, ...(workshopEffects?.flameGlow || {}) },
    waterStream: { ...defaultEffects.waterStream, ...(workshopEffects?.waterStream || {}) }
  }
  // ============================================================================
  // STATE VARIABLES: These change during gameplay
  // ============================================================================

  // How much water is currently in the pot, in kilograms (0 = empty, typically 1.0kg = full)
  const [waterInPot, setWaterInPot] = useState(0)

  // Non-volatile residue mass (kg) remaining after evaporation (e.g., salt in saltwater)
  const [residueMass, setResidueMass] = useState(0)

  // Current temperature of the water in Celsius (starts at room temperature)
  const [temperature, setTemperature] = useState(GAME_CONFIG.ROOM_TEMPERATURE)

  // Fluid properties (loaded from JSON, defaults to water)
  // Contains specific heat, heat of vaporization, cooling coefficient, etc.
  const [fluidProps, setFluidProps] = useState(null)

  // Track fluid loading errors instead of falling back to hardcoded defaults
  const [fluidLoadError, setFluidLoadError] = useState(null)

  // Active fluid selection (for Level 3+)
  const [activeFluid, setActiveFluid] = useState(DEFAULT_SUBSTANCE)

  // Available fluids for dropdown
  const [availableFluids, setAvailableFluids] = useState([])

  // Burner heat setting: 0=off, 1=low, 2=med, 3=high
  // Controls the output power of the gas burner
  // Only applies heat when pot is over the flame AND knob is turned on
  const [burnerHeat, setBurnerHeat] = useState(0)

  // Time speed multiplier (1x = normal, 2x = double speed, 4x = 4x speed, etc.)
  const [timeSpeed, setTimeSpeed] = useState(1)

  // Has the water reached its boiling point? (true once boiling starts)
  const [isBoiling, setIsBoiling] = useState(false)

  // Has the boil popup been shown for this experiment? (prevents re-triggering)
  // Only resets on fluid/level change, not on temperature fluctuation
  const [hasShownBoilPopup, setHasShownBoilPopup] = useState(false)

  // Should we display the educational message about boiling points?
  // (This appears when water starts boiling)
  const [showHook, setShowHook] = useState(false)

  // Time from when pot was placed over flame to boiling (for stats)
  const [boilTime, setBoilTime] = useState(0)
  
  // Time at which pot was first placed over flame (to track boil duration)
  const [timePotOnFlame, setTimePotOnFlame] = useState(null)

  // Burner heat setting (0-3) when boiling was achieved (for ideal time calculation)
  const [burnerHeatWhenBoiled, setBurnerHeatWhenBoiled] = useState(0)

  // Snapshot of experiment stats captured at the moment of boiling
  const [boilStats, setBoilStats] = useState(null)

  // Should we pause time flow while popup is visible?
  const [pauseTime, setPauseTime] = useState(false)
  const [showNextLevelButton, setShowNextLevelButton] = useState(false)

  // How many seconds have elapsed since heat was turned on (used for time calculations)
  const [timeElapsed, setTimeElapsed] = useState(0)
  
  // Is the timer running? (user can start/stop manually)
  const [isTimerRunning, setIsTimerRunning] = useState(false)

  // Where is the pot positioned on the screen? Uses percentages (0-100%)
  // x: 0% = left edge, 100% = right edge
  // y: 0% = top edge, 100% = bottom edge
  // The pot&#39;s center is positioned at these coordinates
  // Support both old (pot.start) and new (pot.empty) layout structures
  const potStartPos = layout.pot.start || layout.pot.empty || { xPercent: 50, yPercent: 50 }
  const [potPosition, setPotPosition] = useState({ x: potStartPos.xPercent, y: potStartPos.yPercent })

  // Resolve heat steps from burner config (new system) or legacy workshopLayout (fallback)
  const wattageSteps = useMemo(() =&gt; {
    // New system: burnerConfig from room.json + burners/{id}.json
    if (burnerConfig?.wattageSteps &amp;&amp; Array.isArray(burnerConfig.wattageSteps) &amp;&amp; burnerConfig.wattageSteps.length &gt; 0) {
      return burnerConfig.wattageSteps
    }
    // Legacy fallback: burnerControls in workshop.json
    const customSteps = workshopLayout?.burnerControls?.wattageSteps
    if (customSteps &amp;&amp; Array.isArray(customSteps) &amp;&amp; customSteps.length &gt; 0) return customSteps
    return [0, 400, 1700, 2500]
  }, [burnerConfig, workshopLayout])
  const maxHeatIndex = wattageSteps.length - 1

  // Is the user currently dragging the pot? (true = dragging, false = not dragging)
  const [isDragging, setIsDragging] = useState(false)

  // When dragging starts, we store the offset between the mouse and pot center
  // This prevents the pot from &quot;jumping&quot; to the cursor position
  // Example: if user clicks 50 pixels left of pot center, dragOffset.x = -50
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 })

  // The dimensions of the game window (workshop-provided, default 1280x800)
  const [sceneDimensions, setSceneDimensions] = useState({ width: 0, height: 0 })

  // ============================================================================
  // LOCATION &amp; ALTITUDE INPUT: For Level 2+ altitude effects experiment
  // ============================================================================

  // User&#39;s entered zip code (for location lookup)
  const [userZipCode, setUserZipCode] = useState(&#39;&#39;)

  // User&#39;s selected country (USA, UK, Australia, Canada)
  const [userCountry, setUserCountry] = useState(&#39;USA&#39;)

  // Manual altitude input (in meters) as fallback
  const [manualAltitude, setManualAltitude] = useState(&#39;&#39;)
  // Editable altitude input for different-fluids experiment
  const [editableAltitude, setEditableAltitude] = useState(null)
  // Track if user has confirmed any location/altitude to avoid reopening popup
  // Initialize based on whether location prop already has data
  const [hasSetLocation, setHasSetLocation] = useState(
    () =&gt; Boolean(location?.altitude !== 0 || location?.name)
  )

  // Is location lookup currently in progress?
  const [isLoadingLocation, setIsLoadingLocation] = useState(false)

  // Location lookup error message
  const [locationError, setLocationError] = useState(null)

  // User&#39;s entered location display name (e.g., &quot;Denver, USA&quot;)
  // Initialize from location prop if available
  const [locationName, setLocationName] = useState(() =&gt; location?.name || null)
  const [showLocationPopup, setShowLocationPopup] = useState(false)

  // ============================================================================
  // DERIVED STATE: Post-Tutorial Status
  // ============================================================================

  // Find current experiment object (needed for order check and room controls)
  const currentExperimentObj = useMemo(() =&gt; {
    const experiments = EXPERIMENTS[activeLevel] || []
    return experiments.find(exp =&gt; exp.id === activeExperiment) || null
  }, [activeLevel, activeExperiment])

  // Advanced mode is available after completing tutorial OR skipping it
  // showSelectors indicates tutorial has been passed/skipped (selectors only appear then)
  const isAdvancedModeAvailable = showSelectors &amp;&amp; (hasBoiledBefore || activeLevel !== 0)
  
  // Check if current experiment requires location setup (order &gt;= 2 means past tutorial)
  const currentExperimentOrder = currentExperimentObj?.order ?? 1
  // L1E2 (altitude-effect) is THE altitude experiment - it prompts for location
  // All other experiments after L1E2 just use whatever altitude was previously set
  const isAltitudeExperiment = activeExperiment === &#39;altitude-effect&#39;
  // Location popup allowed for any experiment past tutorial (order &gt;= 2) or any level &gt; 1
  const isLocationPopupAllowed = activeLevel &gt; 1 || currentExperimentOrder &gt;= 2
  // Altitude controls should be available once selectors are unlocked or for altitude experiment
  const showAltitudeControls = showSelectors || isAltitudeExperiment
  
  // Trigger location popup ONLY for altitude-effect experiment (L1E2) if location not yet set
  useEffect(() =&gt; {
    if (isAltitudeExperiment &amp;&amp; !hasSetLocation &amp;&amp; !showLocationPopup) {
      setShowLocationPopup(true)
    }
  }, [activeExperiment, isAltitudeExperiment, hasSetLocation, showLocationPopup])

  // Reset pot position when layout changes
  useEffect(() =&gt; {
    const potStartPos = layout.pot.start || layout.pot.empty || { xPercent: 50, yPercent: 50 }
    setPotPosition({ x: potStartPos.xPercent, y: potStartPos.yPercent })
  }, [workshopLayout])

  // Clamp burner heat to available steps when layout changes
  useEffect(() =&gt; {
    if (burnerHeat &gt; maxHeatIndex) {
      setBurnerHeat(maxHeatIndex)
    }
  }, [maxHeatIndex, burnerHeat])

  // ============================================================================
  // LOCATION &amp; ALTITUDE: Affects boiling point (must be before room environment)
  // ============================================================================

  // Get the user&#39;s altitude in meters (defaults to 0 if location data not available)
  // Higher altitude = lower atmospheric pressure = lower boiling point
  const altitude = (activeExperiment === &#39;different-fluids&#39; &amp;&amp; editableAltitude !== null)
    ? editableAltitude
    : (location?.altitude || 0)

  // ============================================================================
  // ROOM ENVIRONMENT: Temperature, pressure, composition tracking (L1E4+)
  // ============================================================================
  
  // Room controls are enabled when the experiment has unlocksRoomControls flag
  const roomControlsEnabled = Boolean(currentExperimentObj?.unlocksRoomControls)
  
  // Initialize room environment hook (manages room temp, pressure, composition)
  // Pass altitude so room pressure uses ISA calculation based on player&#39;s location
  const {
    roomState,
    summary: roomSummary,
    alerts: roomAlerts,
    updateRoom,
    addVapor,
    setAcEnabled,
    setAcSetpoint,
    setAirHandlerMode,
    resetRoom
  } = useRoomEnvironment(roomConfig, acUnitConfig, airHandlerConfig, altitude)

  // ============================================================================
  // REFERENCES: Direct access to DOM elements (not state, just object references)
  // ============================================================================

  // Stores reference to the pot div element (used to get its position during dragging)
  const potRef = useRef(null)

  // Stores reference to the game scene div (used to calculate coordinates relative to it)
  const sceneRef = useRef(null)

  // Stores reference to the heating simulation interval so we can stop it later
  const simulationRef = useRef(null)

  // Pre-calculate what temperature fluid will boil at
  // PRESSURE FEEDBACK LOOP:
  // - Before L1E4: Use altitude to derive pressure (standard behavior)
  // - At L1E4+ (room controls enabled): Use room pressure directly
  //   This creates a feedback loop: boiling ‚Üí vapor release ‚Üí pressure rise ‚Üí BP shift
  const boilingPointResult = useMemo(() =&gt; {
    if (!fluidProps) return null
    
    // When room controls are enabled, use room pressure for feedback loop
    if (roomControlsEnabled &amp;&amp; roomSummary?.pressure) {
      return calculateBoilingPointAtPressure(roomSummary.pressure, fluidProps)
    }
    
    // Standard: derive pressure from altitude
    return calculateBoilingPoint(altitude, fluidProps)
  }, [fluidProps, altitude, roomControlsEnabled, roomSummary?.pressure])
  
  const boilingPoint = boilingPointResult?.temperature ?? null
  const isBoilingPointExtrapolated = boilingPointResult?.isExtrapolated ?? false
  const boilingPointVerifiedRange = boilingPointResult?.verifiedRange ?? { min: null, max: null }
  const canBoil = Boolean(fluidProps?.canBoil) &amp;&amp; Number.isFinite(boilingPoint)
  const boilingPointSeaLevel = Number.isFinite(fluidProps?.boilingPointSeaLevel)
    ? fluidProps.boilingPointSeaLevel
    : null

  const fluidName = fluidProps?.name || &#39;Fluid&#39;
  const liquidMass = Math.max(0, waterInPot - residueMass)

  // ============================================================================
  // AMBIENT TEMPERATURE: For cooling/heating equilibration
  // Before L1E4: Fixed at 20¬∞C
  // At L1E4+: Uses room environment temperature (affected by AC)
  // ============================================================================
  const ambientTemperature = roomControlsEnabled &amp;&amp; roomSummary?.temperature != null
    ? roomSummary.temperature
    : GAME_CONFIG.ROOM_TEMPERATURE

  // ============================================================================
  // ============================================================================
  // EFFECT 1: Load substance properties (runs once on component load, or when room controls change)
  // ============================================================================

  // Load available fluids for dropdown (Level 3+)
  // L1E3: Only safe fluids (no requiresRoomControls flag)
  // L1E4+: All fluids (room controls available for hazardous materials)
  useEffect(() =&gt; {
    async function loadFluids() {
      const fluids = await getAvailableSubstances()
      const ambientTemperature = GAME_CONFIG.ROOM_TEMPERATURE

      const fluidCandidates = await Promise.all(
        fluids.all.map(async (substanceId) =&gt; {
          try {
            const info = await loadSubstanceInfo(substanceId)
            const props = parseSubstanceProperties(info)

            const meltingPoint = props?.meltingPoint
            const boilingPoint = props?.boilingPointSeaLevel
            
            // Check if substance requires room controls (hazardous materials)
            const needsRoomControls = info?.gameFlags?.requiresRoomControls || false
            
            // Filter out dangerous substances if room controls not enabled
            if (needsRoomControls &amp;&amp; !roomControlsEnabled) {
              return null  // Skip hazardous materials in L1E3
            }

            if (
              Number.isFinite(meltingPoint) &amp;&amp;
              Number.isFinite(boilingPoint) &amp;&amp;
              ambientTemperature &gt; meltingPoint &amp;&amp;
              ambientTemperature &lt; boilingPoint
            ) {
              return substanceId
            }
          } catch (error) {
            return null
          }

          return null
        })
      )

      const filteredFluids = fluidCandidates.filter(Boolean)
      setAvailableFluids(filteredFluids)
    }
    loadFluids()
  }, [roomControlsEnabled])  // Re-filter when room controls unlock (L1E3 ‚Üí L1E4)

  useEffect(() =&gt; {
    setShowNextLevelButton(false)
  }, [activeExperiment, activeLevel])

  // Load the current substance&#39;s properties from JSON
  useEffect(() =&gt; {
    async function initializeFluid() {
      try {
        const substanceData = await loadSubstance(activeFluid)
        const props = parseSubstanceProperties(substanceData)
        setFluidProps(props)
        setFluidLoadError(null)
        setResidueMass(0)
      } catch (error) {
        console.error(&#39;Failed to load fluid properties:&#39;, error)
        setFluidProps(null)
        setFluidLoadError(error)
      }
    }
    initializeFluid()
  }, [activeFluid, workshopLayout])

  // EFFECT 2: Initialize the game window dimensions (runs once on component load)
  // ============================================================================

  useEffect(() =&gt; {
    // This &quot;effect&quot; runs only once when the component first appears
    // It sets up the game window to be exactly 1280x800 pixels
    const updateDimensions = () =&gt; {
      if (sceneRef.current) {
        // We set dimensions to a fixed size (matching the background image dimensions)
        // This ensures all percentage-based positioning stays consistent
        setSceneDimensions({
          width: layout.scene.width,   // Fixed width in pixels
          height: layout.scene.height  // Fixed height in pixels
        })
      }
    }

    // Call it immediately when component loads
    updateDimensions()
    
    // Empty dependency array [] means: only run once, never again
    // If we removed the [], it would run every time any state changes
  }, [])

  // ============================================================================
  // EFFECT 3: Physics simulation loop (runs continuously when water is in pot)
  // ============================================================================

  // ============================================================================
  // EFFECT 3: Physics simulation loop (runs continuously when water is in pot)
  // ============================================================================

  useEffect(() =&gt; {
    // This effect handles the physics simulation of heating/cooling water
    // It runs continuously while there&#39;s water in the pot
    // Heat is only applied when the pot is over the flame
    // Now uses Newton&#39;s Law of Cooling for realistic temperature decay
    if (liquidMass &lt;= 0 || !fluidProps) return  // Wait for fluid props to load

    // Define the heat activation area around the flame (workshop-driven)
    const flameX = layout.flame.xPercent
    const flameY = layout.flame.yPercent
    const heatActivationRadius = layout.flame.activationRadius
    
    // Start a repeating timer that runs every TIME_STEP milliseconds (e.g., every 100ms)
    simulationRef.current = setInterval(() =&gt; {
      // Skip simulation if time is paused (e.g., popup visible)
      if (pauseTime) return
      
      // Calculate distance from pot center to flame center
      const deltaX = Math.abs(potPosition.x - flameX)
      const deltaY = Math.abs(potPosition.y - flameY)
      const distanceToFlame = Math.sqrt(deltaX * deltaX + deltaY * deltaY)
      
      // Check if pot is within the heat activation area
      const potOverFlame = distanceToFlame &lt;= heatActivationRadius
      
      // Determine heat output based on burner knob setting and pot position
      // Heat only applies when BOTH conditions are true:
      // 1. Burner knob is turned on (not set to 0/off)
      // 2. Pot is positioned over the flame
      let heatInputWatts = 0
      if (burnerHeat &gt; 0 &amp;&amp; potOverFlame) {
        const heatLevels = wattageSteps
        heatInputWatts = heatLevels[burnerHeat] || 0
        
        // Track when pot is first placed over flame with heat on
        // Initialize to 0 if just started, otherwise accumulate time
        if (timePotOnFlame === null) {
          setTimePotOnFlame(0)
        } else {
          // Accumulate time while heating (deltaTime calculated below, use TIME_STEP for now)
          const dt = (GAME_CONFIG.TIME_STEP / 1000) * timeSpeed
          setTimePotOnFlame(prev =&gt; (prev ?? 0) + dt)
        }
      } else if (timePotOnFlame !== null) {
        // Reset if pot is removed from flame or heat is turned off
        setTimePotOnFlame(null)
      }
      // If heat is off or pot is not over flame, heatInputWatts stays 0
      // Newton&#39;s Law of Cooling will handle the temperature decay automatically

      // Convert the TIME_STEP from milliseconds to seconds
      // If TIME_STEP = 100 (milliseconds), deltaTime = 0.1 (seconds)
      // Multiply by timeSpeed to speed up simulation (2x, 4x, 8x, etc.)
      const deltaTime = (GAME_CONFIG.TIME_STEP / 1000) * timeSpeed

      // Call the physics engine function to calculate what happens in this time step
      // It takes:
      // - Current fluid properties (mass, temperature, altitude)
      // - Heat being applied (Watts, 0 for natural cooling)
      // - Time elapsed in this step (seconds √ó speed multiplier)
      // - Fluid properties (specific heat, cooling coefficient, etc.)
      // - Ambient temperature for equilibration
      // And returns new temperature, fluid mass, and whether it&#39;s boiling
      const newState = simulateTimeStep(
        {
          waterMass: waterInPot,         // How much fluid (kg)
          temperature: temperature,      // Current temperature (¬∞C)
          altitude: altitude,            // Current altitude (meters)
          residueMass: residueMass       // Non-volatile residue (kg)
        },
        heatInputWatts,                   // How much heat to apply (Watts)
        deltaTime,                        // How much time this step represents (seconds)
        fluidProps,                       // Fluid properties (specific heat, cooling, etc.)
        ambientTemperature                // Room temperature for equilibration
      )

      // Update all the values returned from the physics simulation
      setTemperature(newState.temperature)      // Water is now hotter or cooler
      setWaterInPot(newState.waterMass)        // Water mass decreases if boiling (evaporation)
      
      // Room environment: Track burner heat and vapor release
      // The main room simulation (AC, air handler) runs in a separate effect
      // Here we only add external heat sources and vapor from boiling
      if (roomControlsEnabled &amp;&amp; roomConfig) {
        // Track burner heat (waste heat radiating into room)
        if (heatInputWatts &gt; 0) {
          updateRoom(deltaTime, &#39;experiment_burner&#39;, heatInputWatts)
        }
        
        // ========== PRE-BOILING EVAPORATION (Mass Transfer Model) ==========
        // Even below boiling point, volatile substances evaporate!
        // This cools the liquid (can go BELOW ambient) and adds vapor to room.
        // Uses Fuller-Schettler-Giddings diffusion + boundary layer mass transfer.
        // Only runs when NOT boiling (boiling evaporation is handled separately).
        if (!newState.isBoiling &amp;&amp; fluidProps?.antoineCoefficients &amp;&amp; newState.waterMass &gt; 0) {
          // Get vapor pressure at current temperature
          const vaporPressure = solveAntoineForPressure(newState.temperature, fluidProps.antoineCoefficients)
          
          if (vaporPressure &amp;&amp; vaporPressure &gt; 0) {
            // Get partial pressure of this substance already in room air
            // Use atmosphere key from chemical formula (e.g., &#39;H‚ÇÇO&#39; -&gt; &#39;H2O&#39;)
            const atmosphereKey = getAtmosphereKey(activeFluid, fluidProps)
            const roomComposition = roomState?.composition || {}
            const totalPressure = roomState?.pressure || 101325
            const partialPressure = (roomComposition[atmosphereKey] || 0) * totalPressure
            
            // Calculate evaporation using mass transfer model (physically accurate)
            // Uses diffusion coefficient from Fuller-Schettler-Giddings equation
            // and natural convection mass transfer correlations
            const evapResult = simulateEvaporationWithMassTransfer({
              liquidTempC: newState.temperature,
              liquidMassKg: newState.waterMass,
              vaporPressurePa: vaporPressure,
              pressurePa: totalPressure,
              molarMassGmol: fluidProps.molarMass || 18.015,
              latentHeatKJ: fluidProps.heatOfVaporization || 2257,
              specificHeatJgC: fluidProps.specificHeat || 4.186,
              potDiameterM: 0.2,  // 20cm pot
              partialPressurePa: partialPressure,
              diffusionVolumeSum: fluidProps.diffusionVolumeSum,  // Calculated at load time from element data
              deltaTimeS: deltaTime
            })
            
            // Apply evaporative cooling (can cool below ambient!)
            // IMPORTANT: Apply to newState.temperature (from heating sim), not prev!
            if (evapResult.massEvaporatedKg &gt; 1e-9) {
              // Combine heating result + evaporative cooling
              const finalTemp = newState.temperature + evapResult.tempChangeC
              setTemperature(finalTemp)
              setWaterInPot(evapResult.newMassKg)
              
              // Add vapor to room air composition (pass formula for atmosphere key)
              addVapor(activeFluid, evapResult.massEvaporatedKg, fluidProps?.molarMass || 18.015, fluidProps?.chemicalFormula)
            }
          }
        }
        
        // If water is boiling, add boiling-phase vapor to room
        if (newState.isBoiling &amp;&amp; newState.waterMass &lt; waterInPot) {
          const evaporatedMass = waterInPot - newState.waterMass
          addVapor(activeFluid, evaporatedMass, fluidProps?.molarMass || 18.015, fluidProps?.chemicalFormula)
        }
      }
      
      // Track elapsed time only if timer is running
      if (isTimerRunning) {
        setTimeElapsed(prev =&gt; prev + deltaTime)  // Track elapsed time (accounts for speed)
      }

      // Check if water just started boiling
      // We only show &quot;boiling&quot; if it wasn&#39;t boiling before but is now boiling
      // hasShownBoilPopup prevents re-triggering if temp fluctuates around boiling point
      if (newState.isBoiling &amp;&amp; !isBoiling &amp;&amp; !hasShownBoilPopup) {
        setIsBoiling(true)   // Mark as boiling
        setHasShownBoilPopup(true)  // Prevent re-triggering
        setShowHook(true)    // Show the educational message
        setPauseTime(true)   // Pause time while popup is visible
        setShowNextLevelButton(Boolean(getNextProgression()))
        // Calculate time it took to boil (from when pot was placed over flame)
        const elapsedBoilTime = timePotOnFlame !== null ? timePotOnFlame + deltaTime : 0
        setBoilTime(elapsedBoilTime)
        // Capture the burner heat setting when boiling is achieved
        setBurnerHeatWhenBoiled(burnerHeat)
        
        // Capture snapshot of all experiment stats at moment of boiling
        setBoilStats({
          temperature: newState.temperature,
          boilingPoint: boilingPoint,
          boilingPointSeaLevel: fluidProps?.boilingPointSeaLevel ?? null,
          altitude: altitude,
          locationName: locationName,
          fluidName: fluidProps?.name || &#39;Fluid&#39;,
          fluidId: activeFluid,
          timeToBoil: elapsedBoilTime,
          burnerHeat: burnerHeat,
          experiment: activeExperiment,
          level: activeLevel,
          // Room environment data (L1E4+)
          roomData: roomControlsEnabled ? {
            initialComposition: roomState?.initialComposition || null,
            finalComposition: roomState?.composition || null,
            initialTemperature: roomState?.initialTemperature || null,
            finalTemperature: roomState?.temperature || null,
            energyTotals: roomState?.energyTotals || null,
            exposureEvents: roomState?.exposureEvents || [],
            alerts: roomAlerts || []
          } : null
        })
        
        onWaterBoiled?.()    // Notify parent that water has boiled
      }
      
      // Stop boiling if temperature drops below boiling point (pot removed from heat)
      if (canBoil &amp;&amp; newState.temperature &lt; boilingPoint &amp;&amp; isBoiling) {
        setIsBoiling(false)
      }

      if (!canBoil &amp;&amp; isBoiling) {
        setIsBoiling(false)
      }
    }, GAME_CONFIG.TIME_STEP)  // Repeat every TIME_STEP milliseconds

    // Cleanup function: runs when component unmounts or dependencies change
    // This stops the interval so we don&#39;t have multiple intervals running
    return () =&gt; {
      if (simulationRef.current) {
        clearInterval(simulationRef.current)
      }
    }
  }, [waterInPot, liquidMass, residueMass, temperature, altitude, boilingPoint, canBoil, isBoiling, hasShownBoilPopup, timeSpeed, potPosition, burnerHeat, fluidProps, workshopLayout, isTimerRunning, pauseTime])  // Re-run if any of these change

  // ============================================================================
  // EFFECT 4: Room environment simulation (AC, air handler) - runs independently
  // ============================================================================

  useEffect(() =&gt; {
    // This effect handles room environment simulation (temperature regulation, air handling)
    // It runs independently of whether there&#39;s liquid in the pot
    // Only active when room controls are enabled (L1E4+)
    if (!roomControlsEnabled || !roomConfig) return
    
    const roomSimRef = setInterval(() =&gt; {
      // Skip if time is paused
      if (pauseTime) return
      
      // Calculate timestep (same as main simulation)
      const deltaTime = (GAME_CONFIG.TIME_STEP / 1000) * timeSpeed
      
      // Update room environment (AC maintains temperature, air handler cleans air)
      // Pass 0 for heat since we&#39;re not tracking burner heat here (that happens in main sim)
      updateRoom(deltaTime, null, 0)
    }, GAME_CONFIG.TIME_STEP)
    
    return () =&gt; clearInterval(roomSimRef)
  }, [roomControlsEnabled, roomConfig, timeSpeed, pauseTime, updateRoom])

  // ============================================================================
  // POT DRAGGING HANDLERS: Three functions handle the drag lifecycle
  // ============================================================================

  /**
   * handleFluidChange - Called when user selects a different fluid from dropdown
   * Resets pot and loads new fluid properties
   */
  const handleFluidChange = (e) =&gt; {
    const newFluid = e.target.value
    setActiveFluid(newFluid)
    // Reset pot state when switching fluids
    setWaterInPot(0)
    setTemperature(ambientTemperature)  // Start at current room temperature
    setIsBoiling(false)
    setHasShownBoilPopup(false)  // Allow popup to trigger again for new fluid
    setShowHook(false)
    setBoilStats(null)
  }

  /**
   * handlePointerDown - Called when user presses pointer (mouse/touch/pen) on pot
   * Starts the dragging process
   */
  const handlePointerDown = (e) =&gt; {
    // Prevent any default browser behavior (like native drag-and-drop)
    e.preventDefault()

    // Safety check: make sure the pot element exists
    if (!potRef.current || !sceneRef.current) return

    // Request &quot;pointer capture&quot; - this tells the browser that all pointer events
    // should go to this element while dragging, even if cursor moves outside it
    // Without this, moving too fast could lose the drag
    try {
      potRef.current.setPointerCapture(e.pointerId)
    } catch (_) {
      // If the browser doesn&#39;t support this, continue anyway (older browsers)
    }

    // Mark that we are now dragging
    setIsDragging(true)

    // Calculate the &quot;drag offset&quot; - the distance between where the user clicked
    // and the pot&#39;s center. This prevents the pot from jumping to the cursor.
    // 
    // Example: If pot center is at pixel 500 and user clicks at pixel 450 (left side)
    // Then dragOffset = 450 - 500 = -50
    // Later, when pot follows cursor to position 550, the offset keeps it from snapping
    const rect = potRef.current.getBoundingClientRect()  // Get pot&#39;s current size/position
    const centerX = rect.left + rect.width / 2           // Calculate center X position
    const centerY = rect.top + rect.height / 2           // Calculate center Y position

    setDragOffset({
      x: e.clientX - centerX,  // How far left/right from center
      y: e.clientY - centerY   // How far up/down from center
    })
  }

  /**
   * handlePointerMove - Called continuously while pointer is held down and dragging
   * Updates the pot position to follow the cursor
   */
  const handlePointerMove = (e) =&gt; {
    // Only process this if we&#39;re currently dragging
    if (!isDragging || !sceneRef.current) return

    // Get the game scene&#39;s position on screen
    const sceneRect = sceneRef.current.getBoundingClientRect()

    // Calculate where the user&#39;s cursor is, relative to the game scene
    // Subtract the drag offset so the pot follows the cursor correctly
    // newX and newY are in pixels
    let newX = e.clientX - sceneRect.left - dragOffset.x
    let newY = e.clientY - sceneRect.top - dragOffset.y

    // Convert from pixel coordinates to percentages (0-100%)
    // This makes pot position independent of screen size
    // If game window is 1280 pixels wide and newX is 640, then newXPercent = 50%
    let newXPercent = (newX / sceneDimensions.width) * 100
    let newYPercent = (newY / sceneDimensions.height) * 100

    // Apply boundary constraints: keep pot mostly on screen
    // Min values (8%) and max values (92%) account for the pot&#39;s transparent corners
    // A 36% size pot with center at 8% means left edge is at 8-18 = -10% (mostly off)
    // A 36% size pot with center at 92% means right edge is at 92+18 = 110% (mostly off)
    // But visible pot can nearly reach the edges
    newXPercent = Math.max(8, Math.min(newXPercent, 92))
    newYPercent = Math.max(8, Math.min(newYPercent, 92))

    // Update the pot&#39;s position state
    setPotPosition({ x: newXPercent, y: newYPercent })

    // AUTO-FILL: Check if pot is in the water stream area
    // Water stream is from (295,451) to (285,724) in original 1024x1024 image
    // Converting to percentages: X is around 27-29%, Y is from 44% to 71%
    // We check if pot center is passing through this vertical stream AND pot is empty
    const inWaterStream =
      newXPercent &gt;= layout.waterStream.xRange[0] &amp;&amp;
      newXPercent &lt;= layout.waterStream.xRange[1] &amp;&amp;
      newYPercent &gt;= layout.waterStream.yRange[0] &amp;&amp;
      newYPercent &lt;= layout.waterStream.yRange[1]
    if (inWaterStream &amp;&amp; liquidMass &lt; 0.1) {  // Refill if nearly empty (&lt; 0.1kg)
      // Auto-fill with the default water amount (1.0 kg)
      const fillMass = GAME_CONFIG.DEFAULT_WATER_MASS
      const nonVolatileFraction = fluidProps?.nonVolatileMassFraction ?? 0
      setWaterInPot(fillMass)
      setResidueMass(fillMass * nonVolatileFraction)
      // Reset temperature to current room/ambient temp when filling with fresh fluid
      setTemperature(ambientTemperature)
      // Reset boiling state
      setIsBoiling(false)
      setHasShownBoilPopup(false)  // Allow popup to trigger for fresh fill
      // Reset burner heat tracking
      setBurnerHeatWhenBoiled(0)
    }
  }

  /**
   * handlePointerUp - Called when user releases pointer (stops dragging)
   */
  const handlePointerUp = (e) =&gt; {
    // Release the pointer capture so other elements can receive events again
    try {
      if (potRef.current?.hasPointerCapture?.(e.pointerId)) {
        potRef.current.releasePointerCapture(e.pointerId)
      }
    } catch (_) {
      // If release fails, continue anyway
    }

    // Mark that we&#39;re no longer dragging
    setIsDragging(false)
  }

  // ============================================================================
  // BUTTON HANDLERS
  // ============================================================================

  /**
  * Cycle through time speed options: 1x ‚Üí 2x ‚Üí 4x ‚Üí ... ‚Üí 65536x (Basic Mode)
   */
  const handleSpeedUp = () =&gt; {
    setTimeSpeed(current =&gt; {
      // From fractional speeds, go to pause (0)
      if (current &lt; 1) return 0
      // From pause, go to 1x
      if (current === 0) return 1
      // Normal progression (doubling)
      const doubled = current * 2
      return doubled &lt;= 65536 ? doubled : 65536  // Cap at 65536x
    })
  }

  /**
   * Double the time speed (Advanced Mode)
   */
  const handleSpeedDouble = () =&gt; {
    setTimeSpeed(current =&gt; {
      // Handle pause state: 0 -&gt; 1x
      if (current === 0) return 1
      const doubled = current * 2
      return doubled &lt;= 65536 ? doubled : 65536  // Cap at 65536x
    })
  }

  /**
   * Halve the time speed (Advanced Mode)
   * Progression: 1x -&gt; 0 (pause) -&gt; 1/2x -&gt; 1/4x -&gt; ... -&gt; 1/65536x
   */
  const handleSpeedHalve = () =&gt; {
    const minSpeed = 1 / 65536  // 1/65536x as slowest
    setTimeSpeed(current =&gt; {
      // At 1x, go to pause (0)
      if (current === 1) return 0
      // At pause, go to 1/2x
      if (current === 0) return 0.5
      // Normal halving
      const halved = current / 2
      return halved &gt;= minSpeed ? halved : minSpeed  // Min 1/65536x speed
    })
  }

  /**
   * Quick pause button - toggle between current speed and 0 (pause)
   */
  const handleQuickPause = () =&gt; {
    setTimeSpeed(current =&gt; {
      // If already paused, return to 1x
      if (current === 0) return 1
      // Otherwise pause
      return 0
    })
  }

  /**
   * Toggle timer (start/stop)
   */
  const handleTimerToggle = () =&gt; {
    setIsTimerRunning(prev =&gt; !prev)
  }
  
  /**
   * Reset timer to zero
   */
  const handleTimerReset = () =&gt; {
    setTimeElapsed(0)
  }

  /**
  * Cycle through burner heat settings: off ‚Üí low ‚Üí med ‚Üí high ‚Üí off
   * 0=off, 1=low (400W), 2=med (1700W), 3=high (2500W)
   */
  const handleBurnerKnob = () =&gt; {
    setBurnerHeat(current =&gt; (current &gt;= maxHeatIndex ? 0 : current + 1))
  }

  const handleHeatDown = () =&gt; {
    setBurnerHeat(current =&gt; Math.max(0, current - 1))
  }

  const handleHeatUp = () =&gt; {
    setBurnerHeat(current =&gt; Math.min(maxHeatIndex, current + 1))
  }

  /**
   * Transitions to the next stage (more educational content) when user clicks &quot;Learn More&quot;
   */
  const handleLearnMore = () =&gt; {
    // Call the parent component callback to change the game stage
    // This transitions from Stage 0 (gameplay) to Stage 1 (educational content)
    onStageChange(1)
  }

  const getNextExperimentInLevel = () =&gt; {
    // Get all experiments for current level, sorted by order
    const levelExperiments = EXPERIMENTS[activeLevel]?.slice().sort((a, b) =&gt; (a.order || 0) - (b.order || 0)) || []
    const currentIndex = levelExperiments.findIndex((exp) =&gt; exp.id === activeExperiment)
    const nextExp = currentIndex &gt;= 0 ? levelExperiments[currentIndex + 1] : null
    return nextExp?.id ?? null
  }

  const getNextLevelId = () =&gt; {
    const sortedLevels = LEVELS.slice().sort((a, b) =&gt; (a.order || 0) - (b.order || 0))
    const currentIndex = sortedLevels.findIndex((level) =&gt; level.id === activeLevel)
    const nextLevel = currentIndex &gt;= 0 ? sortedLevels[currentIndex + 1] : null
    return nextLevel?.id ?? null
  }

  const getNextProgression = () =&gt; {
    // Check for next experiment in current level first
    const nextExp = getNextExperimentInLevel()
    if (nextExp) {
      return { type: &#39;experiment&#39;, id: nextExp }
    }
    // If no next experiment, check for next level
    const nextLevel = getNextLevelId()
    if (nextLevel) {
      // Get first experiment of next level
      const firstExp = EXPERIMENTS[nextLevel]?.[0]?.id
      return { type: &#39;level&#39;, levelId: nextLevel, experimentId: firstExp }
    }
    return null
  }

  const handleNextProgression = () =&gt; {
    const progression = getNextProgression()
    if (!progression) return

    setShowHook(false)
    setPauseTime(false)
    setShowNextLevelButton(false)
    setBoilStats(null)

    if (progression.type === &#39;experiment&#39;) {
      onExperimentChange?.(progression.id)
    } else if (progression.type === &#39;level&#39;) {
      onLevelChange?.(progression.levelId)
      onExperimentChange?.(progression.experimentId)
    }
  }

  /**
   * Proceed to next stage from info screen
   */
  const handleNextStage = () =&gt; {
    onStageChange(stage + 1)
  }

  // ============================================================================
  // LOCATION &amp; ALTITUDE HANDLERS
  // ============================================================================

  /**
   * Handle location search - works worldwide (city names, landmarks, etc.)
   */
  const handleSearchLocation = async () =&gt; {
    if (!userZipCode.trim()) {
      setLocationError(&#39;Please enter a location (city, landmark, region, etc.)&#39;)
      return
    }

    setIsLoadingLocation(true)
    setLocationError(null)

    try {
      const { getAltitudeFromLocationName } = await import(&#39;../utils/locationUtils&#39;)
      const result = await getAltitudeFromLocationName(userZipCode)
      
      // Update the location through parent component
      onLocationChange?.({
        altitude: result.altitude,
        name: result.name,
        fullName: result.fullName,
        latitude: result.latitude,
        longitude: result.longitude
      })

      setLocationName(result.name)
      setLocationError(null)
      setUserZipCode(&#39;&#39;)  // Clear input after successful search
      setManualAltitude(&#39;&#39;)  // Clear manual input
      setHasSetLocation(true)
      setShowLocationPopup(false)  // Close popup after selection
    } catch (error) {
      setLocationError(error.message || &#39;Location not found. Try a city, landmark, or geographic feature.&#39;)
      console.error(&#39;Location search error:&#39;, error)
    } finally {
      setIsLoadingLocation(false)
    }
  }

  /**
   * Handle manual altitude entry
   */
  const handleSetManualAltitude = () =&gt; {
    const altitudeNum = parseFloat(manualAltitude)
    
    // Allow any number (negative for below sea level: Death Valley -86m, Dead Sea -430m)
    if (isNaN(altitudeNum)) {
      setLocationError(&#39;Please enter a valid altitude in meters (negative for below sea level)&#39;)
      return
    }

    onLocationChange?.({
      altitude: altitudeNum,
      latitude: null,
      longitude: null
    })

    // Manual altitude entry clears location name (shows only altitude in panel)
    setLocationName(&#39;&#39;)
    setUserZipCode(&#39;&#39;)
    setManualAltitude(&#39;&#39;)
    setLocationError(null)
    setHasSetLocation(true)
    setShowLocationPopup(false)  // Close popup after selection
  }

  /**
   * Handle browser geolocation
   */
  const handleFindMyLocation = async () =&gt; {
    setIsLoadingLocation(true)
    setLocationError(null)

    try {
      const { getUserLocation } = await import(&#39;../utils/locationUtils&#39;)
      const result = await getUserLocation()
      
      onLocationChange?.({
        altitude: result.altitude,
        name: result.name,
        latitude: result.latitude,
        longitude: result.longitude
      })

      setLocationName(result.name)
      setUserZipCode(&#39;&#39;)
      setManualAltitude(&#39;&#39;)
      setLocationError(null)
      setHasSetLocation(true)
      setShowLocationPopup(false)  // Close popup after selection
    } catch (error) {
      setLocationError(error.message || &#39;Could not access your location&#39;)
      console.error(&#39;Geolocation error:&#39;, error)
    } finally {
      setIsLoadingLocation(false)
    }
  }

  /**
   * Reset location - show popup again to change location
   */
  const handleResetLocation = () =&gt; {
    setLocationName(null)
    setUserZipCode(&#39;&#39;)
    setManualAltitude(&#39;&#39;)
    setLocationError(null)
    setHasSetLocation(false)
    setShowLocationPopup(true)  // Show popup again for selection
    onLocationChange?.({
      altitude: 0,
      name: null,
      latitude: null,
      longitude: null
    })
  }

  // ============================================================================
  // CALCULATED VALUES (derived from state)
  // ============================================================================

  // Original background image dimensions (what it is in the PNG file)
  const baseWidth = layout.scene.width   // pixels - current display width
  const baseHeight = layout.scene.height   // pixels - current display height

  // Calculate scale factors (not used much since we use percentages, but kept for reference)
  const scaleX = sceneDimensions.width / baseWidth
  const scaleY = sceneDimensions.height / baseHeight
  const scale = Math.min(scaleX, scaleY)

  // Flame position (workshop-driven)
  const flameX = layout.flame.xPercent
  const flameY = layout.flame.yPercent

  // Calculate water stream position (from original 1024x1024: starts at 295,451 ends at 285,724)
  const waterStreamStartX = layout.waterStream.start.xPercent
  const waterStreamStartY = layout.waterStream.start.yPercent
  const waterStreamEndX = layout.waterStream.end.xPercent
  const waterStreamEndY = layout.waterStream.end.yPercent
  const waterStreamHeight = waterStreamEndY - waterStreamStartY

  // Workshop-driven optional glow/steam tuning
  const flameGlowConfig = effects.flameGlow
  const flameGlowIntensity = flameGlowConfig.intensityByHeat?.[burnerHeat] ?? 1
  const flameGlowBlur = (flameGlowConfig.blurPx ?? 16) * flameGlowIntensity
  const flameGlowColor = flameGlowConfig.color || &#39;var(--workshop-flame-glow, #ff3300)&#39;
  const flameFilter = flameGlowConfig.enabled
    ? `drop-shadow(0 0 ${flameGlowBlur}px ${flameGlowColor})`
    : undefined
  const flameAnimationDuration = flameGlowConfig.flickerMs
    ? `${flameGlowConfig.flickerMs}ms`
    : undefined

  const steamConfig = effects.steam
  const steamStyle = {
    &#39;--steam-duration&#39;: `${(steamConfig.durationMs ?? 1500) / 1000}s`,
    &#39;--steam-rise&#39;: `${steamConfig.risePx ?? -40}px`,
    &#39;--steam-size&#39;: `${steamConfig.sizeRem ?? 1.5}rem`,
    &#39;--steam-color&#39;: steamConfig.color,
    &#39;--steam-glow&#39;: steamConfig.glow,
    top: `${steamConfig.offset?.yPx ?? -30}px`,
    left: `calc(50% + ${steamConfig.offset?.xPercent ?? 0}%)`
  }

  // Check if pot is in the water stream area to show the pouring effect
  // Only show if workshop has explicitly enabled waterStream effect
  // SPECIAL CASE: If substance boils at or below ambient temperature,
  // show upward steam instead of downward water stream
  const boilsAtAmbient = fluidProps &amp;&amp; Number.isFinite(boilingPoint) &amp;&amp; boilingPoint &lt;= ambientTemperature
  
  const showWaterStream = !boilsAtAmbient &amp;&amp; effects.waterStream.enabled &amp;&amp;
    potPosition.x &gt;= layout.waterStream.xRange[0] &amp;&amp;
    potPosition.x &lt;= layout.waterStream.xRange[1] &amp;&amp;
    potPosition.y &gt;= layout.waterStream.yRange[0] &amp;&amp;
    potPosition.y &lt;= layout.waterStream.yRange[1]
  
  const showAmbientSteam = boilsAtAmbient &amp;&amp; effects.waterStream.enabled &amp;&amp;
    potPosition.x &gt;= layout.waterStream.xRange[0] &amp;&amp;
    potPosition.x &lt;= layout.waterStream.xRange[1] &amp;&amp;
    potPosition.y &gt;= layout.waterStream.yRange[0] &amp;&amp;
    potPosition.y &lt;= layout.waterStream.yRange[1]

  // Check if pot is positioned over the burner (for status display)
  const heatActivationRadius = layout.flame.activationRadius
  const deltaXToFlame = Math.abs(potPosition.x - flameX)
  const deltaYToFlame = Math.abs(potPosition.y - flameY)
  const distanceToFlameCenter = Math.sqrt(deltaXToFlame * deltaXToFlame + deltaYToFlame * deltaYToFlame)
  const isPotOverFlame = distanceToFlameCenter &lt;= heatActivationRadius

  // Calculate expected time to boil (in real-world seconds)
  // Q = m * c * ŒîT  (energy needed)
  // Time = Q / Power (in seconds)
  const calculateExpectedBoilTime = () =&gt; {
    if (!fluidProps || !canBoil || liquidMass === 0 || temperature &gt;= boilingPoint) return null
    const powerWatts = wattageSteps[burnerHeat] || 0
    if (powerWatts === 0) return null
    
    if (!Number.isFinite(fluidProps.specificHeat)) return null
    const specificHeat = fluidProps.specificHeat * 1000  // Convert J/g to J/kg
    const tempDelta = boilingPoint - temperature
    const energyNeeded = liquidMass * specificHeat * tempDelta  // Joules
    const timeSeconds = energyNeeded / powerWatts  // Seconds
    return timeSeconds
  }

  const expectedBoilTime = calculateExpectedBoilTime()

  // Format time in mm:ss
  const formatTime = (seconds) =&gt; {
    if (seconds === null || seconds === undefined) return &#39;--:--&#39;
    const mins = Math.floor(seconds / 60)
    const secs = Math.floor(seconds % 60)
    return `${mins}:${secs.toString().padStart(2, &#39;0&#39;)}`
  }

  // Calculate ideal boil time based on burner heat setting
  // (Energy needed: Q = mcŒîT = 1000g √ó 4.186 J/(g¬∑¬∞C) √ó 80¬∞C = 334,880 Joules)
  // (Time = Energy / Power in Watts, but accounting for altitude pressure effects)
  const calculateIdealBoilTime = (heatLevel, boilPointTarget) =&gt; {
    const watts = wattageSteps[heatLevel] || wattageSteps[2]  // default to medium if invalid
    
    if (watts === 0) return null  // Can&#39;t boil without heat
    if (!fluidProps || !canBoil || !Number.isFinite(boilPointTarget)) return null
    
    // Energy to heat fluid from current ambient temp to boiling point
    const waterMass = GAME_CONFIG.DEFAULT_WATER_MASS * 1000  // grams
    if (!Number.isFinite(fluidProps.specificHeat)) return null
    const specificHeat = fluidProps.specificHeat  // J/(g¬∑¬∞C)
    const tempDifference = boilPointTarget - ambientTemperature
    
    const energyNeeded = waterMass * specificHeat * tempDifference  // Joules
    const timeSeconds = energyNeeded / watts
    
    return timeSeconds
  }

  // Drag boundaries: how far the pot center can move (in percentages)
  // These are conservative to keep the pot mostly on screen
  const maxXPercent = layout.pot.dragBounds.maxX
  const maxYPercent = layout.pot.dragBounds.maxY
  const minXPercent = layout.pot.dragBounds.minX
  const minYPercent = layout.pot.dragBounds.minY

  // ============================================================================
  // RENDER: Build and return the UI
  // ============================================================================

  if (!hasRequiredImages) {
    return (
      &lt;div className=&quot;info-screen&quot;&gt;
        &lt;div className=&quot;info-content&quot;&gt;
          &lt;h2&gt;‚ö†Ô∏è Workshop Assets Missing&lt;/h2&gt;
          &lt;p&gt;This workshop must provide all required images (background, pot, flame). Add them in the workshop JSON before running the scene.&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    )
  }

  if (fluidLoadError) {
    return (
      &lt;div className=&quot;info-screen&quot;&gt;
        &lt;div className=&quot;info-content&quot;&gt;
          &lt;h2&gt;‚ö†Ô∏è Substance Data Load Failed&lt;/h2&gt;
          &lt;p&gt;{fluidLoadError.message || &#39;Unable to load substance properties from data files.&#39;}&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    )
  }

  // Stage 0: Interactive game scene
  return (
    &lt;div className=&quot;game-scene&quot;&gt;
      {/* 
        The outer game-scene div fills the entire browser viewport
        It&#39;s centered in the middle and has a black background for letterboxing
      */}

      &lt;div 
        ref={sceneRef}
        className=&quot;game-scene-inner&quot;
        style={{
          backgroundImage: `url(${backgroundImage})`,
          width: `${layout.scene.width}px`,
          height: `${layout.scene.height}px`,
          backgroundSize: &#39;100% 100%&#39;
        }}
      &gt;
        {/* 
          ========== WATER STREAM (Water Source) ==========
          Pouring water effect from faucet area
          Appears only when pot is passing through the stream
        */}
        {showWaterStream &amp;&amp; (
          &lt;div 
            className=&quot;water-stream&quot;
            style={{
              left: `${waterStreamStartX}%`,
              top: `${waterStreamStartY}%`,
              width: `${layout.waterStream.widthPercent}%`,
              height: `${waterStreamHeight}%`
            }}
          /&gt;
        )}
        
        {/* 
          ========== AMBIENT-BOILING STEAM (For low-boiling substances) ==========
          Upward steam effect for substances that boil at or below 20¬∞C (room temp)
          Examples: Hydrogen (-252¬∞C), Oxygen (-183¬∞C), Nitrogen (-196¬∞C)
          Shows colored steam rising instead of downward water stream
        */}
        {showAmbientSteam &amp;&amp; fluidProps &amp;&amp; (
          &lt;div 
            className=&quot;ambient-boil-steam&quot;
            style={{
              left: `${waterStreamStartX}%`,
              top: `${waterStreamStartY}%`,
              width: `${layout.waterStream.widthPercent}%`,
              height: `${waterStreamHeight}%`,
              // Use substance-specific color from catalog if available
              backgroundColor: fluidProps.color?.gas || &#39;rgba(200, 230, 255, 0.4)&#39;,
              opacity: 0.6
            }}
          /&gt;
        )}

        {/* 
          ========== FLAME (Burner visualization) ==========
          Located at center-right where the burner is
          Shows a flame image when heat is on
        */}
        &lt;div 
          className=&quot;stove-burner&quot;
          style={{
            left: `${flameX}%`,
            top: `${flameY}%`,
            width: burnerHeat === 0 ? &#39;0%&#39; : `${(layout.flame.sizePercentByHeat?.[burnerHeat] ?? layout.flame.sizePercentByHeat?.at(-1) ?? 0)}%`,
            height: burnerHeat === 0 ? &#39;0%&#39; : `${(layout.flame.sizePercentByHeat?.[burnerHeat] ?? layout.flame.sizePercentByHeat?.at(-1) ?? 0)}%`,
            minWidth: burnerHeat === 0 ? &#39;0px&#39; : `${(layout.flame.minSizePxByHeat?.[burnerHeat] ?? layout.flame.minSizePxByHeat?.at(-1) ?? 0)}px`,
            minHeight: burnerHeat === 0 ? &#39;0px&#39; : `${(layout.flame.minSizePxByHeat?.[burnerHeat] ?? layout.flame.minSizePxByHeat?.at(-1) ?? 0)}px`
          }}
        &gt;
          {/* Show flame image when burner is on; glow/animation effects applied only if workshop enables them */}
          {burnerHeat &gt; 0 &amp;&amp; (
            &lt;img 
              src={flameImage}
              alt=&quot;Gas burner flame&quot;
              className=&quot;flame-graphic&quot;
              style={{
                filter: effects.flameGlow.enabled ? flameFilter : &#39;none&#39;,
                animationDuration: effects.flameGlow.enabled ? flameAnimationDuration : &#39;0s&#39;
              }}
            /&gt;
          )}
        &lt;/div&gt;

        {/* Button-based burner controls (for workshops that replace the knob) */}
        {layout.burnerControls?.type === &#39;buttons&#39; &amp;&amp; (
          &lt;&gt;
            &lt;div
              className=&quot;burner-wattage-display&quot;
              style={{
                left: `${layout.burnerControls.wattageDisplay.xPercent}%`,
                top: `${layout.burnerControls.wattageDisplay.yPercent}%`,
                width: `${layout.burnerControls.wattageDisplay.widthPercent}%`,
                height: `${layout.burnerControls.wattageDisplay.heightPercent}%`,
                border: `${layout.burnerControls.wattageDisplay.borderPx || 1}px solid ${layout.burnerControls.wattageDisplay.borderColor || &#39;#333&#39;}`,
                background: layout.burnerControls.wattageDisplay.backgroundColor || &#39;#f0f0f0&#39;,
                color: layout.burnerControls.wattageDisplay.textColor || &#39;#000&#39;,
              }}
            &gt;
              {`${wattageSteps[burnerHeat] || 0} W`}
            &lt;/div&gt;

            &lt;span id=&quot;burner-controls-help&quot; className=&quot;sr-only&quot;&gt;
              Adjust the burner power level to change heating intensity.
            &lt;/span&gt;

            &lt;button
              className=&quot;burner-btn burner-btn-down&quot;
              style={{
                left: `${layout.burnerControls.downButton.xPercent}%`,
                top: `${layout.burnerControls.downButton.yPercent}%`,
                width: `${layout.burnerControls.downButton.sizePercent}%`,
                height: `${layout.burnerControls.downButton.sizePercent}%`,
              }}
              onClick={handleHeatDown}
              aria-label=&quot;Burner down&quot;
              aria-describedby=&quot;burner-controls-help&quot;
              title=&quot;Decrease burner wattage&quot;
            &gt;
              {layout.burnerControls.downButton.symbol || &#39;‚Üì&#39;}
              &lt;div className=&quot;burner-btn-label&quot;&gt;{layout.burnerControls.downButton.label || &#39;down&#39;}&lt;/div&gt;
            &lt;/button&gt;

            &lt;button
              className=&quot;burner-btn burner-btn-up&quot;
              style={{
                left: `${layout.burnerControls.upButton.xPercent}%`,
                top: `${layout.burnerControls.upButton.yPercent}%`,
                width: `${layout.burnerControls.upButton.sizePercent}%`,
                height: `${layout.burnerControls.upButton.sizePercent}%`,
              }}
              onClick={handleHeatUp}
              aria-label=&quot;Burner up&quot;
              aria-describedby=&quot;burner-controls-help&quot;
              title=&quot;Increase burner wattage&quot;
            &gt;
              {layout.burnerControls.upButton.symbol || &#39;‚Üë&#39;}
              &lt;div className=&quot;burner-btn-label&quot;&gt;{layout.burnerControls.upButton.label || &#39;up&#39;}&lt;/div&gt;
            &lt;/button&gt;
          &lt;/&gt;
        )}

        {/* 
          ========== BURNER KNOB (Heat Control) ==========
          Tiny dial control at the bottom of the stove
          Render only when the workshop provides burnerKnob layout
        */}
        {layout.burnerKnob &amp;&amp; (
          &lt;div 
            className=&quot;burner-knob&quot;
                        role=&quot;button&quot;
                        tabIndex={0}
                        onKeyDown={(e) =&gt; e.key === &#39;Enter&#39; || e.key === &#39; &#39; ? e.preventDefault() : null}
                        aria-label=&quot;Burner control knob - click to adjust heat&quot;
            style={{
              left: `${layout.burnerKnob.xPercent}%`,
              top: `${layout.burnerKnob.yPercent}%`,
              width: `${layout.burnerKnob.sizePercent}%`,
              height: `${layout.burnerKnob.sizePercent}%`,
            }}
            onClick={handleBurnerKnob}
            title={`Burner: ${wattageSteps[burnerHeat] || 0} W`}
          &gt;
            {/* Outer knob rim */}
            &lt;div className=&quot;knob-rim&quot;&gt;&lt;/div&gt;
            {/* Inner knob center */}
            &lt;div className=&quot;knob-center&quot;&gt;&lt;/div&gt;
            {/* Indicator line showing current position */}
            &lt;div className=&quot;knob-pointer&quot; style={{ transform: `rotate(${180 + burnerHeat * 90}deg)` }}&gt;&lt;/div&gt;
          &lt;/div&gt;
        )}

        {/* 
          ========== DRAGGABLE POT ==========
          The main interactive element
          User drags this to the sink to fill it, then moves it to the burner
        */}
        &lt;div
          ref={potRef}
          className={`pot-draggable ${isDragging ? &#39;dragging&#39; : &#39;&#39;} ${liquidMass &gt; 0 ? &#39;filled&#39; : &#39;empty&#39;}`}
          style={{
            left: `${potPosition.x}%`,      // Current X position (updated while dragging)
            top: `${potPosition.y}%`,       // Current Y position (updated while dragging)
            width: `${layout.pot.sizePercent}%`,
            height: `${layout.pot.sizePercent}%`,
            touchAction: &#39;none&#39;             // Disable default browser touch behaviors (scroll, zoom, etc.)
          }}
          onPointerDown={handlePointerDown}  // Start dragging when user clicks
          onPointerMove={handlePointerMove}  // Update position while dragging
          onPointerUp={handlePointerUp}      // Stop dragging when user releases
          onDragStart={(e) =&gt; e.preventDefault()}  // Prevent native browser image drag-and-drop
        &gt;
          {/* 
            Show the appropriate pot image based on whether it has water
            - pot-empty.png: when liquidMass === 0
            - pot-full.png: when liquidMass &gt; 0
          */}
          &lt;img
            src={liquidMass &gt; 0 ? potFullImage : potEmptyImage}
            alt={liquidMass &gt; 0 ? &#39;Pot filled with liquid&#39; : &#39;Empty pot&#39;}
            className=&quot;pot-image&quot;
            draggable={false}  // Disable browser&#39;s native drag for images
          /&gt;
          
          {/* Show steam animation when water is actively boiling at/above boiling point (workshop-tunable, optional) */}
          {steamConfig.enabled &amp;&amp; isBoiling &amp;&amp; temperature &gt;= boilingPoint &amp;&amp; (
            &lt;div className=&quot;steam-effect&quot; style={steamStyle}&gt;
              {steamConfig.asset ? (
                &lt;img
                  src={steamConfig.asset}
                  alt=&quot;Steam rising from the pot&quot;
                  className=&quot;steam-sprite&quot;
                  draggable={false}
                /&gt;
              ) : (
                steamConfig.symbol || &#39;üí®&#39;
              )}
            &lt;/div&gt;
          )}
        &lt;/div&gt;

        {/* 
          ========== CONTROL PANEL ==========
          Extracted component handling all UI controls, status display, and location/altitude selection
        */}
        &lt;ControlPanel
          // Game state
          liquidMass={liquidMass}
          temperature={temperature}
          isBoiling={isBoiling}
          residueMass={residueMass}
          fluidName={fluidName}
          boilingPoint={boilingPoint}
          canBoil={canBoil}
          isPotOverFlame={isPotOverFlame}
          expectedBoilTime={expectedBoilTime}
          formatTemperature={formatTemperature}
          ambientTemperature={ambientTemperature}
          
          // Extrapolation warning data
          isBoilingPointExtrapolated={isBoilingPointExtrapolated}
          boilingPointVerifiedRange={boilingPointVerifiedRange}
          
          // UI state
          timeSpeed={timeSpeed}
          isTimerRunning={isTimerRunning}
          timeElapsed={timeElapsed}
          activeExperiment={activeExperiment}
          activeFluid={activeFluid}
          availableFluids={availableFluids}
          isAdvancedModeAvailable={isAdvancedModeAvailable}
          altitude={altitude}
          locationName={locationName}
          showLocationPopup={showLocationPopup}
          isLocationPopupAllowed={isLocationPopupAllowed}
          locationError={locationError}
          isLoadingLocation={isLoadingLocation}
          userZipCode={userZipCode}
          manualAltitude={manualAltitude}
          editableAltitude={editableAltitude}
          showNextLevelButton={showNextLevelButton}
          
          // Config
          burnerHeat={burnerHeat}
          wattageSteps={wattageSteps}
          GAME_CONFIG={GAME_CONFIG}
          
          // Callbacks
          handleTimerToggle={handleTimerToggle}
          handleTimerReset={handleTimerReset}
          handleSpeedUp={handleSpeedUp}
          handleSpeedDouble={handleSpeedDouble}
          handleSpeedHalve={handleSpeedHalve}
          handleQuickPause={handleQuickPause}
          handleFluidChange={handleFluidChange}
          handleNextProgression={handleNextProgression}
          nextProgressionType={getNextProgression()?.type}
          handleSearchLocation={handleSearchLocation}
          handleSetManualAltitude={handleSetManualAltitude}
          handleFindMyLocation={handleFindMyLocation}
          onLocationChange={onLocationChange}
          setEditableAltitude={setEditableAltitude}
          setShowLocationPopup={setShowLocationPopup}
          setUserZipCode={setUserZipCode}
          setManualAltitude={setManualAltitude}
          setLocationError={setLocationError}
          setLocationName={setLocationName}
          setIsLoadingLocation={setIsLoadingLocation}
          setHasSetLocation={setHasSetLocation}
        /&gt;

        {/* 
          ========== ROOM CONTROLS ==========
          AC and air handler controls, room state display
          Only visible for experiments with unlocksRoomControls flag (L1E4+)
        */}
        &lt;RoomControls
          enabled={roomControlsEnabled}
          summary={roomSummary}
          alerts={roomAlerts}
          acUnit={acUnitConfig}
          airHandler={airHandlerConfig}
          availableAcUnits={roomConfig?.availableAcUnits}
          availableAirHandlers={roomConfig?.availableAirHandlers}
          selectedAcUnitId={acUnitConfig?.id || roomConfig?.defaults?.acUnit}
          selectedAirHandlerId={airHandlerConfig?.id || roomConfig?.defaults?.airHandler}
          onAcEnabledChange={setAcEnabled}
          onAcSetpointChange={setAcSetpoint}
          onAirHandlerModeChange={setAirHandlerMode}
          onAcUnitChange={(id) =&gt; onEquipmentChange?.(&#39;ac-units&#39;, id)}
          onAirHandlerChange={(id) =&gt; onEquipmentChange?.(&#39;air-handlers&#39;, id)}
        /&gt;

        {/* 
          ========== EDUCATIONAL HOOK ==========
          Shows experiment-specific results when boiling is achieved
          Always pauses simulation while visible
        */}

        {/* Scorecard Popup - Centered modal with experiment-specific stats */}
        {showHook &amp;&amp; boilStats &amp;&amp; (
          &lt;div className=&quot;boil-stats-overlay&quot;&gt;
            &lt;div className=&quot;boil-stats-modal&quot;&gt;
              {/* EXPERIMENT 1: Tutorial - Basic Boiling */}
              {boilStats.experiment === &#39;boiling-water&#39; &amp;&amp; (
                &lt;&gt;
                  &lt;h2&gt;üéâ You Boiled Water!&lt;/h2&gt;
                  &lt;p className=&quot;modal-subtitle&quot;&gt;Great job completing the tutorial!&lt;/p&gt;

                  &lt;div className=&quot;stats-grid&quot;&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Boiling Point:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPoint)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Time to Boil:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTime(boilStats.timeToBoil)}&lt;/span&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;

                  &lt;div className=&quot;info-content&quot;&gt;
                    &lt;h3&gt;üéì What You Learned&lt;/h3&gt;
                    &lt;ul&gt;
                      &lt;li&gt;&lt;strong&gt;Heat Transfer:&lt;/strong&gt; The burner transferred thermal energy to the water molecules&lt;/li&gt;
                      &lt;li&gt;&lt;strong&gt;Temperature Rise:&lt;/strong&gt; As molecules gained energy, they moved faster, increasing temperature&lt;/li&gt;
                      &lt;li&gt;&lt;strong&gt;Boiling Point:&lt;/strong&gt; At {formatTemperature(boilStats.boilingPointSeaLevel ?? 100)}¬∞C (sea level), water molecules gain enough energy to escape as vapor&lt;/li&gt;
                    &lt;/ul&gt;
                    &lt;p className=&quot;fun-fact&quot;&gt;üèîÔ∏è &lt;strong&gt;Next Up:&lt;/strong&gt; Try the Altitude experiment to see how location changes the boiling point!&lt;/p&gt;
                  &lt;/div&gt;
                &lt;/&gt;
              )}

              {/* EXPERIMENT 2: Altitude Effect */}
              {boilStats.experiment === &#39;altitude-effect&#39; &amp;&amp; (
                &lt;&gt;
                  &lt;h2&gt;üìç Altitude Experiment Complete!&lt;/h2&gt;
                  &lt;p className=&quot;modal-subtitle&quot;&gt;
                    You boiled water at {boilStats.locationName || `${boilStats.altitude.toLocaleString()}m altitude`}
                  &lt;/p&gt;

                  &lt;div className=&quot;stats-grid&quot;&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Your Altitude:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{boilStats.altitude.toLocaleString()} m&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Boiling Point Here:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPoint)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Sea Level Boiling Point:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPointSeaLevel ?? 100)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Difference:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;
                        {formatTemperature((boilStats.boilingPointSeaLevel ?? 100) - boilStats.boilingPoint)}¬∞C lower
                      &lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Time to Boil:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTime(boilStats.timeToBoil)}&lt;/span&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;

                  &lt;div className=&quot;info-content&quot;&gt;
                    &lt;h3&gt;üéì Why Does Altitude Matter?&lt;/h3&gt;
                    &lt;ul&gt;
                      &lt;li&gt;&lt;strong&gt;Lower Pressure:&lt;/strong&gt; At higher altitudes, there&amp;apos;s less air pushing down on the water&lt;/li&gt;
                      &lt;li&gt;&lt;strong&gt;Easier Escape:&lt;/strong&gt; Water molecules need less energy to escape as vapor&lt;/li&gt;
                      &lt;li&gt;&lt;strong&gt;Result:&lt;/strong&gt; Water boils at a lower temperature ({formatTemperature(boilStats.boilingPoint)}¬∞C vs {formatTemperature(boilStats.boilingPointSeaLevel ?? 100)}¬∞C)&lt;/li&gt;
                    &lt;/ul&gt;
                    &lt;p className=&quot;fun-fact&quot;&gt;üèîÔ∏è &lt;strong&gt;Fun Fact:&lt;/strong&gt; At the top of Mount Everest (8,849m), water boils at only ~68¬∞C!&lt;/p&gt;
                  &lt;/div&gt;
                &lt;/&gt;
              )}

              {/* EXPERIMENT 3: Different Fluids */}
              {boilStats.experiment === &#39;different-fluids&#39; &amp;&amp; (
                &lt;&gt;
                  &lt;h2&gt;üß™ {boilStats.fluidName} Boiled!&lt;/h2&gt;
                  &lt;p className=&quot;modal-subtitle&quot;&gt;You successfully boiled {boilStats.fluidName.toLowerCase()}&lt;/p&gt;

                  &lt;div className=&quot;stats-grid&quot;&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Substance:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{boilStats.fluidName}&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Boiling Point:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPoint)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    {boilStats.altitude &gt; 0 &amp;&amp; (
                      &lt;div className=&quot;stat-item&quot;&gt;
                        &lt;span className=&quot;stat-label&quot;&gt;Altitude:&lt;/span&gt;
                        &lt;span className=&quot;stat-value&quot;&gt;{boilStats.altitude.toLocaleString()} m&lt;/span&gt;
                      &lt;/div&gt;
                    )}
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Sea Level Boiling Point:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPointSeaLevel)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Time to Boil:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTime(boilStats.timeToBoil)}&lt;/span&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;

                  &lt;div className=&quot;info-content&quot;&gt;
                    &lt;h3&gt;üéì Why Different Boiling Points?&lt;/h3&gt;
                    &lt;ul&gt;
                      &lt;li&gt;&lt;strong&gt;Molecular Bonds:&lt;/strong&gt; Different substances have different intermolecular forces&lt;/li&gt;
                      &lt;li&gt;&lt;strong&gt;Stronger Bonds = Higher BP:&lt;/strong&gt; Water (100¬∞C) has strong hydrogen bonds&lt;/li&gt;
                      &lt;li&gt;&lt;strong&gt;Weaker Bonds = Lower BP:&lt;/strong&gt; Acetone (56¬∞C) and ethanol (78¬∞C) have weaker bonds&lt;/li&gt;
                    &lt;/ul&gt;
                    &lt;p className=&quot;fun-fact&quot;&gt;üí° &lt;strong&gt;Try This:&lt;/strong&gt; Compare how long it takes to boil different substances with the same heat setting!&lt;/p&gt;
                  &lt;/div&gt;
                &lt;/&gt;
              )}

              {/* L1E4: Dangerous Liquids - Room Environment Scorecard */}
              {boilStats.experiment === &#39;dangerous-liquids&#39; &amp;&amp; (
                &lt;&gt;
                  &lt;h2&gt;‚ö†Ô∏è Hazardous Material Handled!&lt;/h2&gt;
                  &lt;p className=&quot;modal-subtitle&quot;&gt;
                    You boiled {boilStats.fluidName} in a controlled environment
                  &lt;/p&gt;

                  &lt;div className=&quot;stats-grid&quot;&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Substance:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{boilStats.fluidName}&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Boiling Point:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPoint)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Time to Boil:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTime(boilStats.timeToBoil)}&lt;/span&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;

                  {/* Room Environment Section */}
                  {boilStats.roomData &amp;&amp; (
                    &lt;&gt;
                      &lt;h3&gt;üè† Room Environment&lt;/h3&gt;
                      &lt;div className=&quot;stats-grid&quot;&gt;
                        &lt;div className=&quot;stat-item&quot;&gt;
                          &lt;span className=&quot;stat-label&quot;&gt;Room Temp Change:&lt;/span&gt;
                          &lt;span className=&quot;stat-value&quot;&gt;
                            {formatTemperature(boilStats.roomData.initialTemperature)}¬∞C ‚Üí {formatTemperature(boilStats.roomData.finalTemperature)}¬∞C
                          &lt;/span&gt;
                        &lt;/div&gt;
                        {boilStats.roomData.energyTotals &amp;&amp; (
                          &lt;&gt;
                            &lt;div className=&quot;stat-item&quot;&gt;
                              &lt;span className=&quot;stat-label&quot;&gt;AC Cooling Used:&lt;/span&gt;
                              &lt;span className=&quot;stat-value&quot;&gt;
                                {(boilStats.roomData.energyTotals.acCoolingJoules / 1000).toFixed(1)} kJ
                              &lt;/span&gt;
                            &lt;/div&gt;
                            &lt;div className=&quot;stat-item&quot;&gt;
                              &lt;span className=&quot;stat-label&quot;&gt;Air Handler Energy:&lt;/span&gt;
                              &lt;span className=&quot;stat-value&quot;&gt;
                                {(boilStats.roomData.energyTotals.airHandlerJoules / 1000).toFixed(1)} kJ
                              &lt;/span&gt;
                            &lt;/div&gt;
                          &lt;/&gt;
                        )}
                      &lt;/div&gt;

                      {/* Composition Changes */}
                      &lt;h3&gt;üå¨Ô∏è Air Composition&lt;/h3&gt;
                      &lt;div className=&quot;composition-comparison&quot;&gt;
                        &lt;div className=&quot;comp-column&quot;&gt;
                          &lt;strong&gt;Before:&lt;/strong&gt;
                          &lt;ul className=&quot;comp-list&quot;&gt;
                            {Object.entries(boilStats.roomData.initialComposition || {}).slice(0, 5).map(([gas, fraction]) =&gt; (
                              &lt;li key={gas}&gt;{gas}: {(fraction * 100).toFixed(2)}%&lt;/li&gt;
                            ))}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                        &lt;div className=&quot;comp-column&quot;&gt;
                          &lt;strong&gt;After:&lt;/strong&gt;
                          &lt;ul className=&quot;comp-list&quot;&gt;
                            {Object.entries(boilStats.roomData.finalComposition || {}).slice(0, 5).map(([gas, fraction]) =&gt; (
                              &lt;li key={gas}&gt;{gas}: {(fraction * 100).toFixed(2)}%&lt;/li&gt;
                            ))}
                          &lt;/ul&gt;
                        &lt;/div&gt;
                      &lt;/div&gt;

                      {/* Exposure Events / Consequences */}
                      {boilStats.roomData.exposureEvents?.length &gt; 0 &amp;&amp; (
                        &lt;&gt;
                          &lt;h3&gt;‚ö†Ô∏è Exposure Report&lt;/h3&gt;
                          {boilStats.roomData.exposureEvents.map((event, idx) =&gt; (
                            &lt;div key={idx} className={`exposure-event severity-${event.severity}`}&gt;
                              &lt;strong&gt;{event.name}&lt;/strong&gt;
                              &lt;p&gt;Peak: {event.peakPPM.toFixed(0)} ppm | Duration: {formatTime(event.durationSec)}&lt;/p&gt;
                              &lt;p className=&quot;consequence&quot;&gt;{event.consequence}&lt;/p&gt;
                              {event.isProtected &amp;&amp; (
                                &lt;p className=&quot;protected-note&quot;&gt;‚úì Air handler provided protection&lt;/p&gt;
                              )}
                            &lt;/div&gt;
                          ))}
                        &lt;/&gt;
                      )}

                      {/* Safety Tips */}
                      &lt;div className=&quot;info-content&quot;&gt;
                        &lt;h3&gt;üéì Lab Safety&lt;/h3&gt;
                        &lt;ul&gt;
                          &lt;li&gt;&lt;strong&gt;Ventilation:&lt;/strong&gt; Always use proper ventilation with hazardous materials&lt;/li&gt;
                          &lt;li&gt;&lt;strong&gt;Filters Matter:&lt;/strong&gt; Standard filters don&amp;apos;t stop toxic gases - use activated carbon&lt;/li&gt;
                          &lt;li&gt;&lt;strong&gt;Monitor Air:&lt;/strong&gt; Watch for composition changes - rising vapor displaces oxygen&lt;/li&gt;
                        &lt;/ul&gt;
                      &lt;/div&gt;
                    &lt;/&gt;
                  )}
                &lt;/&gt;
              )}

              {/* FALLBACK: Unknown experiment - show generic stats */}
              {![&#39;boiling-water&#39;, &#39;altitude-effect&#39;, &#39;different-fluids&#39;, &#39;dangerous-liquids&#39;].includes(boilStats.experiment) &amp;&amp; (
                &lt;&gt;
                  &lt;h2&gt;üìã Experiment Complete!&lt;/h2&gt;
                  &lt;p className=&quot;modal-subtitle&quot;&gt;You boiled {boilStats.fluidName.toLowerCase()}!&lt;/p&gt;

                  &lt;div className=&quot;stats-grid&quot;&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Substance:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{boilStats.fluidName}&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Boiling Point:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTemperature(boilStats.boilingPoint)}¬∞C&lt;/span&gt;
                    &lt;/div&gt;
                    &lt;div className=&quot;stat-item&quot;&gt;
                      &lt;span className=&quot;stat-label&quot;&gt;Time to Boil:&lt;/span&gt;
                      &lt;span className=&quot;stat-value&quot;&gt;{formatTime(boilStats.timeToBoil)}&lt;/span&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                &lt;/&gt;
              )}

              &lt;button
                className=&quot;action-button continue-button&quot;
                onClick={() =&gt; {
                  setShowHook(false)
                  setPauseTime(false)
                }}
              &gt;
                Close Scorecard
              &lt;/button&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  )
}

export default GameScene


</code></pre>
        </details>
      </section>
    
        </article>
      </main>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
  <script>
    // Lazy-load Kekule only when molecule viewer is expanded (saves bandwidth on low-end devices)
    (() => {
      let smilesDrawerLoaded = false
      let smilesDrawerLoading = false
      
      // Convert explicit SMILES like [CH3][CH](OH)[CH3] to standard like CC(O)C
      const explicitToStandard = (smiles) => {
        return smiles
          // Common organic groups - order matters (longer patterns first)
          .replace(/\[CH3\]/g, 'C')
          .replace(/\[CH2\]/g, 'C')
          .replace(/\[CH\]/g, 'C')
          .replace(/\[OH\]/g, 'O')
          .replace(/\[NH2\]/g, 'N')
          .replace(/\[NH\]/g, 'N')
          .replace(/\[SH\]/g, 'S')
          // Single atoms in brackets (keep aromatic lowercase)
          .replace(/\[C\]/g, 'C')
          .replace(/\[N\]/g, 'N')
          .replace(/\[O\]/g, 'O')
          .replace(/\[S\]/g, 'S')
          .replace(/\[P\]/g, 'P')
          .replace(/\[F\]/g, 'F')
          .replace(/\[Cl\]/g, 'Cl')
          .replace(/\[Br\]/g, 'Br')
          .replace(/\[I\]/g, 'I')
          // Bare atoms in branches - H is implicit in standard SMILES
          .replace(/\(OH\)/g, '(O)')
          .replace(/\(NH2\)/g, '(N)')
          .replace(/\(NH\)/g, '(N)')
          .replace(/\(SH\)/g, '(S)')
      }
      
      const loadSmilesDrawer = async () => {
        if (smilesDrawerLoaded) return
        if (smilesDrawerLoading) {
          return new Promise(resolve => {
            const check = setInterval(() => {
              if (smilesDrawerLoaded) { clearInterval(check); resolve() }
            }, 50)
          })
        }
        smilesDrawerLoading = true
        
        // Load SmilesDrawer from CDN (much simpler than Kekule)
        await new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = 'https://unpkg.com/smiles-drawer@2.1.7/dist/smiles-drawer.min.js'
          script.onload = resolve
          script.onerror = reject
          document.body.appendChild(script)
        })
        
        smilesDrawerLoaded = true
        smilesDrawerLoading = false
      }
      
      const initMolecule = async (node) => {
        if (node.dataset.initialized) return
        node.dataset.initialized = 'true'
        
        const rawSmiles = node.getAttribute('data-smiles')
        if (!rawSmiles) return
        
        // Convert explicit format to standard if needed
        const smiles = explicitToStandard(rawSmiles)
        
        try {
          await loadSmilesDrawer()
          
          const drawer = new SmilesDrawer.SvgDrawer({ 
            width: 300, 
            height: 200,
            explicitHydrogens: true,
            terminalCarbons: true,
            compactDrawing: false
          })
          
          console.log('Parsing SMILES:', rawSmiles, '->', smiles)
          SmilesDrawer.parse(smiles, (tree) => {
            console.log('Parse success, tree:', tree)
            const svgElement = drawer.draw(tree, null, 'light')
            console.log('SVG element:', svgElement)
            node.innerHTML = ''
            node.appendChild(svgElement)
          }, (err) => {
            console.error('SMILES parse error for "' + smiles + '":', err)
            node.innerHTML = '<code>' + rawSmiles + '</code>'
          })
        } catch (err) {
          console.error('SmilesDrawer load error:', err)
          node.innerHTML = '<code>' + smiles + '</code>'
        }
      }
      
      // Use IntersectionObserver for lazy loading when scrolled into view
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initMolecule(entry.target)
            observer.unobserve(entry.target)
          }
        })
      }, { rootMargin: '100px' })
      
      // Also handle <details> expansion for molecules inside collapsed sections
      document.addEventListener('toggle', (e) => {
        if (e.target.tagName === 'DETAILS' && e.target.open) {
          const molecules = e.target.querySelectorAll('[data-smiles]:not([data-initialized])')
          molecules.forEach(node => initMolecule(node))
        }
      }, true)
      
      // Observe all molecule nodes
      const init = () => {
        const nodes = document.querySelectorAll('[data-smiles]')
        nodes.forEach(node => observer.observe(node))
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init)
      } else {
        init()
      }
    })()
  </script>
</body>
</html>